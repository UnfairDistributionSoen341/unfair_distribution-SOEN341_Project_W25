<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatHaven - Servers & Channels</title>
    <link rel="stylesheet" href="./server.css">
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Server Section -->
            <div class="server-section" id="serverSectionView">
                <h2>Servers</h2>
                <input type="text" id="searchServer" placeholder="Search for a server...">
                <button id="createServer">+ Create Server</button>
                <div id="serverList"></div>
            </div>

            <!-- Channel Section (hidden initially) -->
            <div class="channel-section" id="channelSectionView">
                <button class="back-button" id="backToServers">‚Üê Back to Servers</button>
                <h2 id="currentServerName">Server Name</h2>
                <div class="divider"></div>
                <h3>CHANNELS</h3>
                <input type="text" id="searchChannel" placeholder="Search for a channel...">
                <button id="createChannel">+ Create Channel</button>
                <div id="channelList"></div>
            </div>
        </div>

        <!-- Chat Box -->
        <div class="chat-box">
            <div class="chat-header">
                <h2 id="chatChannelName">Select a server and channel to chat</h2>
                <!-- Settings Button -->
                <div class="settings-container">
                    <button id="settingsButton">‚öô Settings</button>
                    <div class="dropdown-menu" id="settingsDropdown">
                        <button id="addMember">‚ûï Add Member</button>
                        <button id="removeMember">‚ûñ Remove Member</button>
                        <button id="viewMembers">üë• Current Members</button>
                    </div>
                </div>
            </div>

            <div id="messages"></div>
            <div class="message-input">
                <input type="text" id="messageInput" placeholder="Type a message...">
                <button id="sendMessage">Send</button>
            </div>
        </div>
    </div>

    <!-- Add Member Popup -->
    <div id="addMemberPopUp" class="popUp">
        <div class="popUp-content">
            <span class="close-button" id="closeAddMemberPopUp">&times;</span>
            <h2>Add Member</h2>
            <input type="text" id="memberUsernameInput" placeholder="Enter username">
            <button id="confirmAddMember">Add Member</button>
        </div>
    </div>

    <!-- Create Server Popup -->
    <div id="createServerPopUp" class="popUp">
        <div class="popUp-content">
            <span class="close-button" id="closeCreateServerPopUp">&times;</span>
            <h2>Create Server</h2>
            <input type="text" id="serverNameInput" placeholder="Enter server name">
            <button id="confirmCreateServer">Create Server</button>
        </div>
    </div>

    <!-- Create Channel Popup -->
    <div id="createChannelPopUp" class="popUp">
        <div class="popUp-content">
            <span class="close-button" id="closeCreateChannelPopUp">&times;</span>
            <h2>Create Channel</h2>
            <input type="text" id="channelNameInput" placeholder="Enter channel name">
            <button id="confirmCreateChannel">Create Channel</button>
        </div>
    </div>

    <button id="logoutButton">Logout</button>
    
    <!-- JS Files -->
    <script src="./settings.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, push, set, get, onChildAdded, off } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDFhghmxUfCJbnnOFsleHoatF7D-ubnLpU",
            authDomain: "project-8042491080443698183.firebaseapp.com",
            databaseURL: "https://project-8042491080443698183-default-rtdb.firebaseio.com",
            projectId: "project-8042491080443698183",
            storageBucket: "project-8042491080443698183.appspot.com",
            messagingSenderId: "583304911847",
            appId: "1:583304911847:web:8dfe3e5c016062dd457b42"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let selectedServer = null;
        let selectedChannel = null;
        
        // DOM Elements for Server & Channel Views
        const serverSectionView = document.getElementById("serverSectionView");
        const channelSectionView = document.getElementById("channelSectionView");
        const backToServersBtn = document.getElementById("backToServers");
        const currentServerNameEl = document.getElementById("currentServerName");
        
        // Initialize UI state
        function initializeUIState() {
            serverSectionView.style.display = "block";
            channelSectionView.style.display = "none";
            document.getElementById("chatChannelName").textContent = "Select a server and channel to chat";
            document.getElementById("messageInput").disabled = true;
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userRef = ref(db, `users/${user.uid}`);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    currentUser.username = snapshot.val().username;
                }
                console.log("‚úÖ Logged in as:", currentUser.username);
                loadServers();
                initializeUIState();
            } else {
                console.error("‚ùå No user detected. Redirecting...");
                window.location.href = "../LoginPage/user_login.html";
            }
        });
        
        // Load servers from database
        async function loadServers() {
            const serverList = document.getElementById("serverList");
            serverList.innerHTML = "";
            try {
                const serversRef = ref(db, "servers");
                const snapshot = await get(serversRef);
                if (snapshot.exists()) {
                    const servers = [];
                    snapshot.forEach((childSnapshot) => {
                        const server = {
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        };
                        if (server.members && server.members[currentUser.uid]) {
                            servers.push(server);
                        }
                    });
                    displayServers(servers);
                } else {
                    serverList.innerHTML = "<p>No servers found.</p>";
                }
            } catch (error) {
                console.error("‚ùå Error loading servers:", error);
            }
        }
        
        // Display servers in the server list
        function displayServers(servers) {
            const serverList = document.getElementById("serverList");
            serverList.innerHTML = servers.length === 0 
                ? "<p>No servers available. Create one!</p>"
                : "";
        
            servers.forEach(server => {
                const serverDiv = document.createElement("div");
                serverDiv.className = "server";
                serverDiv.textContent = server.name;
                serverDiv.addEventListener("click", () => selectServer(server));
                serverList.appendChild(serverDiv);
            });
        }
        
        // Select a server
        function selectServer(server) {
            selectedServer = server;
            currentServerNameEl.textContent = server.name;
            
            // Switch to channel view
            serverSectionView.style.display = "none";
            channelSectionView.style.display = "flex";
            
            // Load channels for this server
            loadChannels(server.id);
        }
        
        // Load channels for a specific server
        async function loadChannels(serverId) {
            const channelList = document.getElementById("channelList");
            channelList.innerHTML = "";
            try {
                const channelsRef = ref(db, `servers/${serverId}/channels`);
                const snapshot = await get(channelsRef);
                
                if (snapshot.exists()) {
                    const channels = [];
                    snapshot.forEach((childSnapshot) => {
                        const channel = {
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        };
                        channels.push(channel);
                    });
                    
                    displayChannels(channels);
                    console.log("Channels loaded:", channels);
                } else {
                    console.log("No channels found for server:", serverId);
                    channelList.innerHTML = "<p>No channels found in this server.</p>";
                }
            } catch (error) {
                console.error("‚ùå Error loading channels:", error);
                channelList.innerHTML = "<p>Error loading channels.</p>";
            }
        }
        
        // Display channels in the channel list
        function displayChannels(channels) {
            const channelList = document.getElementById("channelList");
            channelList.innerHTML = channels.length === 0 
                ? "<p>No channels available. Create one!</p>"
                : "";
        
            channels.forEach(channel => {
                const channelDiv = document.createElement("div");
                channelDiv.className = "channel";
                channelDiv.textContent = channel.name;
                channelDiv.addEventListener("click", () => joinChannel(channel));
                channelList.appendChild(channelDiv);
            });
        }
        
        // Join a channel
        function joinChannel(channel) {
            selectedChannel = channel;
            document.getElementById("chatChannelName").textContent = `#${channel.name} (${selectedServer.name})`;
            document.getElementById("messageInput").disabled = false;
            loadMessages();
        }
        
        // Load messages for a channel
        function loadMessages() {
            const messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML = "";
            const messagesRef = ref(db, `servers/${selectedServer.id}/channels/${selectedChannel.id}/messages`);
        
            off(messagesRef); // Remove any existing listeners
        
            onChildAdded(messagesRef, (snapshot) => {
                const message = snapshot.val();
                const messageElement = document.createElement("div");
                messageElement.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
                messageElement.innerHTML = `
                    <div class="message-header">${message.senderName}</div>
                    <div class="message-text">${message.text}</div>
                    <div class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</div>
                `;
                messagesDiv.appendChild(messageElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }
        
        // Event listeners
        document.addEventListener("DOMContentLoaded", () => {
            // Main buttons
            const sendMessageBtn = document.getElementById("sendMessage");
            const messageInput = document.getElementById("messageInput");
            const createServerBtn = document.getElementById("createServer");
            const createChannelBtn = document.getElementById("createChannel");
            
            // Allow sending message with Enter key
            messageInput.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    sendMessageBtn.click();
                }
            });
            
            // Server popup elements
            const createServerPopUp = document.getElementById("createServerPopUp");
            const closeCreateServerBtn = document.getElementById("closeCreateServerPopUp");
            const confirmCreateServerBtn = document.getElementById("confirmCreateServer");
            
            // Channel popup elements
            const createChannelPopUp = document.getElementById("createChannelPopUp");
            const closeCreateChannelBtn = document.getElementById("closeCreateChannelPopUp");
            const confirmCreateChannelBtn = document.getElementById("confirmCreateChannel");
            
            // Member management
            const addMemberBtn = document.getElementById("addMember");
            const removeMemberBtn = document.getElementById("removeMember");
            const viewMembersBtn = document.getElementById("viewMembers");
            const addMemberPopUp = document.getElementById("addMemberPopUp");
            const closeAddMemberBtn = document.getElementById("closeAddMemberPopUp");
            const confirmAddMemberBtn = document.getElementById("confirmAddMember");
            
            // Back button
            backToServersBtn.addEventListener("click", () => {
                serverSectionView.style.display = "block";
                channelSectionView.style.display = "none";
                document.getElementById("messages").innerHTML = "";
                document.getElementById("chatChannelName").textContent = "Select a server and channel to chat";
                document.getElementById("messageInput").disabled = true;
                selectedServer = null;
                selectedChannel = null;
            });
            
            // Send message
            sendMessageBtn.addEventListener("click", () => {
                const messageText = messageInput.value.trim();
                if (messageText && selectedServer && selectedChannel) {
                    const messagesRef = ref(db, `servers/${selectedServer.id}/channels/${selectedChannel.id}/messages`);
                    push(messagesRef, {
                        text: messageText,
                        senderId: currentUser.uid,
                        senderName: currentUser.username,
                        timestamp: Date.now()
                    });
                    messageInput.value = "";
                }
            });
            
            // Create server
            createServerBtn.addEventListener("click", () => {
                createServerPopUp.style.display = "flex";
            });
            
            closeCreateServerBtn.addEventListener("click", () => {
                createServerPopUp.style.display = "none";
            });
            
            confirmCreateServerBtn.addEventListener("click", async () => {
                const serverName = document.getElementById("serverNameInput").value.trim();
                if (!serverName) {
                    alert("Please enter a server name.");
                    return;
                }
                
                try {
                    const serversRef = ref(db, "servers");
                    const newServerRef = push(serversRef);
                    const newServerId = newServerRef.key;
                    
                    await set(newServerRef, {
                        name: serverName,
                        createdBy: currentUser.uid,
                        createdAt: Date.now(),
                        members: {
                            [currentUser.uid]: currentUser.username
                        }
                    });
                    
                    // Create a default "general" channel
                    const channelsRef = ref(db, `servers/${newServerId}/channels`);
                    await push(channelsRef, {
                        name: "general",
                        createdBy: currentUser.uid,
                        createdAt: Date.now()
                    });
                    
                    alert(`‚úÖ Server "${serverName}" created successfully!`);
                    createServerPopUp.style.display = "none";
                    document.getElementById("serverNameInput").value = "";
                    loadServers();
                } catch (error) {
                    console.error("‚ùå Error creating server:", error);
                    alert("Failed to create server.");
                }
            });
            
            // Create channel
            createChannelBtn.addEventListener("click", () => {
                if (!selectedServer) {
                    alert("‚ùå Please select a server first.");
                    return;
                }
                createChannelPopUp.style.display = "flex";
            });
            
            closeCreateChannelBtn.addEventListener("click", () => {
                createChannelPopUp.style.display = "none";
            });
            
            confirmCreateChannelBtn.addEventListener("click", async () => {
                const channelName = document.getElementById("channelNameInput").value.trim();
                if (!channelName) {
                    alert("Please enter a channel name.");
                    return;
                }
                
                if (!selectedServer) {
                    alert("‚ùå No server selected.");
                    return;
                }
                
                try {
                    const channelsRef = ref(db, `servers/${selectedServer.id}/channels`);
                    await push(channelsRef, {
                        name: channelName,
                        createdBy: currentUser.uid,
                        createdAt: Date.now()
                    });
                    
                    alert(`‚úÖ Channel "${channelName}" created successfully!`);
                    createChannelPopUp.style.display = "none";
                    document.getElementById("channelNameInput").value = "";
                    
                    // Reload channels to show the newly created one
                    loadChannels(selectedServer.id);
                } catch (error) {
                    console.error("‚ùå Error creating channel:", error);
                    alert("Failed to create channel.");
                }
            });
            
            // Add member
            addMemberBtn.addEventListener("click", () => {
                if (!selectedServer) {
                    alert("‚ùå Please select a server first.");
                    return;
                }
                addMemberPopUp.style.display = "flex";
            });
            
            closeAddMemberBtn.addEventListener("click", () => {
                addMemberPopUp.style.display = "none";
            });
            
            confirmAddMemberBtn.addEventListener("click", async () => {
                const username = document.getElementById("memberUsernameInput").value.trim();
                if (!username) {
                    alert("Please enter a username.");
                    return;
                }
                
                if (!selectedServer) {
                    alert("‚ùå No server selected.");
                    return;
                }
                
                try {
                    const usersSnapshot = await get(ref(db, "users"));
                    let userFound = false;
                    
                    usersSnapshot.forEach((userSnap) => {
                        const user = userSnap.val();
                        if (user.username === username) {
                            userFound = true;
                            set(ref(db, `servers/${selectedServer.id}/members/${userSnap.key}`), username);
                        }
                    });
                    
                    if (userFound) {
                        alert(`‚úÖ ${username} was added to ${selectedServer.name} successfully!`);
                        addMemberPopUp.style.display = "none";
                        document.getElementById("memberUsernameInput").value = "";
                    } else {
                        alert("‚ùå User not found.");
                    }
                } catch (error) {
                    console.error("‚ùå Error adding member:", error);
                    alert("Failed to add member.");
                }
            });
            
            // View members
            viewMembersBtn.addEventListener("click", async () => {
                if (!selectedServer) {
                    alert("‚ùå Please select a server first.");
                    return;
                }
                
                try {
                    const membersRef = ref(db, `servers/${selectedServer.id}/members`);
                    const snapshot = await get(membersRef);
                    
                    if (snapshot.exists()) {
                        let membersList = `üë• Members of "${selectedServer.name}":\n`;
                        snapshot.forEach((memberSnap) => {
                            membersList += `- ${memberSnap.val()}\n`;
                        });
                        alert(membersList);
                    } else {
                        alert("‚ùå No members found in this server.");
                    }
                } catch (error) {
                    console.error("‚ùå Error fetching members:", error);
                    alert("Failed to load members.");
                }
            });
            
            // Remove member
            removeMemberBtn.addEventListener("click", async () => {
                if (!selectedServer) {
                    alert("‚ùå Please select a server first.");
                    return;
                }

                try {
                    const membersRef = ref(db, `servers/${selectedServer.id}/members`);
                    const snapshot = await get(membersRef);

                    if (snapshot.exists()) {
                        let membersArray = [];
                        snapshot.forEach((memberSnap) => {
                            membersArray.push({ uid: memberSnap.key, username: memberSnap.val() });
                        });

                        let membersList = `üë• Current Members of "${selectedServer.name}":\n`;
                        membersArray.forEach((member, index) => {
                            membersList += `${index + 1}. ${member.username}\n`;
                        });

                        const usernameToRemove = prompt(`${membersList}\nEnter the username you want to remove:`);

                        if (!usernameToRemove) {
                            return; // User canceled
                        }

                        const memberToRemove = membersArray.find(member =>
                            member.username.toLowerCase() === usernameToRemove.trim().toLowerCase()
                        );

                        if (memberToRemove) {
                            // Check if member is the server creator
                            if (memberToRemove.uid === selectedServer.createdBy) {
                                alert("‚ùå Cannot remove the server creator.");
                                return;
                            }

                            await set(ref(db, `servers/${selectedServer.id}/members/${memberToRemove.uid}`), null);
                            alert(`‚úÖ ${memberToRemove.username} was removed from ${selectedServer.name} successfully!`);
                        } else {
                            alert(`‚ùå User "${usernameToRemove}" not found.`);
                        }
                    } else {
                        alert("‚ùå No members found in this server.");
                    }
                } catch (error) {
                    console.error("‚ùå Error removing member:", error);
                    alert("Failed to remove member.");
                }
            });
        });

        //Logout
        document.getElementById("logoutButton").addEventListener("click", function () {
            console.log("üöÄ Logout button clicked!");

            signOut(auth).then(() => {
                console.log("‚úÖ User logged out. Redirecting...");
                window.top.location.href = "../../Sprint1/LoginPage/user_login.html";
            }).catch((error) => {
                console.error("‚ùå Logout failed:", error);
            });
        });

    </script>
    <script type="module" src="./memberHandler.js"></script>
</body>
</html>
