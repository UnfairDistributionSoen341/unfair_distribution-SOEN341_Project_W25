<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>ChatHaven - Servers & Channels</title>
 <link rel="stylesheet" href="./server.css">
 <style>
 /* Delete button styles */
 .message {
 position: relative;
 }
 
 .delete-btn {
 position: absolute;
 top: 3px;
 right: 3px;
 background-color: rgba(255, 0, 0, 0.1);
 color: #ff0000;
 border: none;
 width: 20px;
 height: 20px;
 border-radius: 50%;
 font-size: 14px;
 cursor: pointer;
 display: none;
 align-items: center;
 justify-content: center;
 padding: 0;
 line-height: 1;
 }
 
 .message:hover .delete-btn {
 display: flex;
 }
 
 .delete-btn:hover {
 background-color: rgba(255, 0, 0, 0.2);
 }

 /* Ensure settings button is always visible */
 #settingsButton {
   display: block !important; /* Use !important to override any inline styles */
   padding: 8px 12px;
   background-color: #333;
   color: white;
   border: none;
   cursor: pointer;
   font-size: 14px;
   border-radius: 5px;
 }

 /* Make the settings dropdown properly positioned for all users */
 .settings-container {
   position: relative;
   display: inline-block;
 }

 .dropdown-menu {
   right: 0;
   top: 40px;
   z-index: 10;
 }
 
 /* Members sidebar styles */
 .members-sidebar {
   width: 200px;
   background: #2C2F33;
   color: white;
   padding: 20px;
   display: flex;
   flex-direction: column;
   border-left: 1px solid #555;
 }
 
 .members-section {
   margin-top: 10px;
   max-height: 100%;
   overflow-y: auto;
 }
 
 .member-item {
   padding: 8px;
   margin: 5px 0;
   background: #444;
   border-radius: 5px;
   display: flex;
   align-items: center;
   justify-content: space-between;
 }
 
 .member-name {
   color: white;
   font-size: 14px;
 }
 
 .member-role {
   font-size: 10px;
   padding: 2px 5px;
   border-radius: 3px;
   color: white;
 }
 
 .role-owner {
   background-color: #ff9800;
 }
 
 .role-admin {
   background-color: #4CAF50;
 }
 
 .role-member {
   background-color: #2196F3;
 }

 /* Updated chat container to include members sidebar */
 .chat-container {
   display: flex;
   width: 90%;
   height: 600px;
   background: white;
   border-radius: 10px;
   overflow: hidden;
   box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.2);
 }
 
 /* Updated chat box width */
 .chat-box {
   flex: 1;
   display: flex;
   flex-direction: column;
 }
 </style>
</head>
<body>
 <div class="chat-container">
 <!-- Left Sidebar -->
 <div class="sidebar">
 <!-- Server Section -->
 <div class="server-section" id="serverSectionView">
 <h2>Servers</h2>
 <input type="text" id="searchServer" placeholder="Search for a server...">
 <button id="createServer">+ Create Server</button>
 <div id="serverList"></div>
 </div>

 <!-- Channel Section (hidden initially) -->
 <div class="channel-section" id="channelSectionView">
 <button class="back-button" id="backToServers">‚Üê Back to Servers</button>
 <h2 id="currentServerName">Server Name</h2>
 <div class="divider"></div>
 <h3>CHANNELS</h3>
 <input type="text" id="searchChannel" placeholder="Search for a channel...">
 <button id="createChannel">+ Create Channel</button>
 <div id="channelList"></div>
 </div>
 </div>

 <!-- Chat Box -->
 <div class="chat-box">
 <div class="chat-header">
 <h2 id="chatChannelName">Select a server and channel to chat</h2>
 <!-- Settings Button -->
 <div class="settings-container">
 <button id="settingsButton">‚öô Settings</button>
 <div class="dropdown-menu" id="settingsDropdown">
 <button id="addMember">‚ûï Add Member</button>
 <button id="manageMembers">üë• Manage Members</button>
 <button id="deleteChannel">üóëÔ∏è Delete Channel</button>
 <button id="manageChannelAccess">üîí Manage Channel Access</button>
 <button id="deleteServer">‚ùå Delete Server</button>
 <button id="leaveServer">üö™ Leave Server</button>
 </div>
 </div>
 </div>

 <div id="messages"></div>
 <div class="message-input">
 <input type="text" id="messageInput" placeholder="Type a message...">
 <button id="sendMessage">Send</button>
 </div>
 </div>
 
 <!-- Members Sidebar (Right) -->
 <div class="members-sidebar" id="membersSidebar">
 <h3>MEMBERS</h3>
 <div id="membersList" class="members-section"></div>
 </div>
 </div>

 <!-- Add Member Popup -->
 <div id="addMemberPopUp" class="popUp">
 <div class="popUp-content">
 <span class="close-button" id="closeAddMemberPopUp">&times;</span>
 <h2>Add Member</h2>
 <input type="text" id="memberUsernameInput" placeholder="Enter username">
 <button id="confirmAddMember">Add Member</button>
 </div>
 </div>

 <!-- Create Server Popup -->
 <div id="createServerPopUp" class="popUp">
 <div class="popUp-content">
 <span class="close-button" id="closeCreateServerPopUp">&times;</span>
 <h2>Create Server</h2>
 <input type="text" id="serverNameInput" placeholder="Enter server name">
 <button id="confirmCreateServer">Create Server</button>
 </div>
 </div>

 <!-- Create Channel Popup -->
 <div id="createChannelPopUp" class="popUp">
 <div class="popUp-content">
 <span class="close-button" id="closeCreateChannelPopUp">&times;</span>
 <h2>Create Channel</h2>
 <input type="text" id="channelNameInput" placeholder="Enter channel name">
 <button id="confirmCreateChannel">Create Channel</button>
 </div>
 </div>

 <button id="logoutButton">Logout</button>
 
 <!-- JS Files -->
 <script src="./settings.js"></script>

 <script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
 import { getDatabase, ref, push, set, get, onChildAdded, off, remove, onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
 import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
 
 const firebaseConfig = {
 apiKey: "AIzaSyDFhghmxUfCJbnnOFsleHoatF7D-ubnLpU",
 authDomain: "project-8042491080443698183.firebaseapp.com",
 databaseURL: "https://project-8042491080443698183-default-rtdb.firebaseio.com",
 projectId: "project-8042491080443698183",
 storageBucket: "project-8042491080443698183.appspot.com",
 messagingSenderId: "583304911847",
 appId: "1:583304911847:web:8dfe3e5c016062dd457b42"
 };
 
 const app = initializeApp(firebaseConfig);
 const db = getDatabase(app);
 const auth = getAuth(app);
 
 let currentUser = null;
 let selectedServer = null;
 let selectedChannel = null;
 
 // DOM Elements for Server & Channel Views
 const serverSectionView = document.getElementById("serverSectionView");
 const channelSectionView = document.getElementById("channelSectionView");
 const membersSidebar = document.getElementById("membersSidebar");
 const backToServersBtn = document.getElementById("backToServers");
 const currentServerNameEl = document.getElementById("currentServerName");
 
 // Initialize UI state
 function initializeUIState() {
   serverSectionView.style.display = "block";
   channelSectionView.style.display = "none";
   membersSidebar.style.display = "none";
   document.getElementById("chatChannelName").textContent = "Select a server and channel to chat";
   document.getElementById("messageInput").disabled = true;
 }
 
 onAuthStateChanged(auth, async (user) => {
 if (user) {
 currentUser = user;
 const userRef = ref(db, `users/${user.uid}`);
 const snapshot = await get(userRef);
 if (snapshot.exists()) {
 currentUser.username = snapshot.val().username;
 }
 console.log("‚úÖ Logged in as:", currentUser.username);
 loadServers();
 initializeUIState();
 } else {
 console.error("‚ùå No user detected. Redirecting...");
 window.location.href = "../LoginPage/user_login.html";
 }
 });
 
 // Get the current user's role in a server
 async function getCurrentUserRole(serverId, userId) {
 if (!serverId || !userId) return "member";
 
 try {
 console.log(`Checking role for user ${userId} in server ${serverId}`);
 
 // Check if user is server creator (owner)
 const serverRef = ref(db, `servers/${serverId}`);
 const serverSnapshot = await get(serverRef);
 
 if (serverSnapshot.exists()) {
 const server = serverSnapshot.val();
 // If user is the server creator, they are the owner
 if (server.createdBy === userId) {
 console.log("User is server creator -> OWNER");
 return "owner";
 }
 }
 
 // Otherwise check their role in members
 const memberRef = ref(db, `servers/${serverId}/members/${userId}`);
 const snapshot = await get(memberRef);
 
 if (!snapshot.exists()) {
 console.log("User not found in members");
 return "member";
 }
 
 // Handle both string username and object with role
 const memberData = snapshot.val();
 console.log("Member data:", memberData);
 
 if (typeof memberData === "object" && memberData.role) {
 console.log(`Found role: ${memberData.role}`);
 return memberData.role;
 }
 
 // If it's just a username string or no role specified
 console.log("No role specified, defaulting to member");
 return "member";
 } catch (error) {
 console.error("Error getting user role:", error);
 return "member";
 }
 }
 
 // Update UI based on user role
 function updateUIBasedOnRole(role) {
    console.log("Current user role:", role);

    const createChannelBtn = document.getElementById("createChannel");
    const deleteChannelBtn = document.getElementById("deleteChannel");
    const deleteServerBtn = document.getElementById("deleteServer");
    const manageMembersBtn = document.getElementById("manageMembers");
    const addMemberBtn = document.getElementById("addMember");
    const manageChannelAccessBtn = document.getElementById("manageChannelAccess");
    const leaveServerBtn = document.getElementById("leaveServer");
    const settingsButton = document.getElementById("settingsButton");
    
    // Settings button should always be visible regardless of role
    settingsButton.style.display = "block";
    
    // Dropdown menu buttons visibility based on role
    createChannelBtn.style.display = (role === "admin" || role === "owner") ? "block" : "none";
    deleteChannelBtn.style.display = (role === "admin" || role === "owner") ? "block" : "none";
    deleteServerBtn.style.display = role === "owner" ? "block" : "none";
    manageMembersBtn.style.display = (role === "admin" || role === "owner") ? "block" : "none";
    manageChannelAccessBtn.style.display = (role === "admin" || role === "owner") ? "block" : "none";
    
    // Show add member button for all roles (now that regular members can add members)
    addMemberBtn.style.display = "block";
    
    // Leave server button is available for all except the owner (owner must transfer ownership first)
    leaveServerBtn.style.display = role !== "owner" ? "block" : "none";
 }
 
 // Updated function to show appropriate dropdown options for regular members
 function updateDropdownForRegularMembers(role) {
    if (role === "member") {
        // Get all dropdown buttons
        const settingsOptions = document.querySelectorAll("#settingsDropdown button");
        
        // Hide all options initially
        settingsOptions.forEach(option => {
            option.style.display = "none";
        });
        
        // Show options for regular members
        document.getElementById("addMember").style.display = "block"; // Allow regular members to add new members
        document.getElementById("leaveServer").style.display = "block"; // Allow members to leave the server
    }
 }
 
 // Function to grant all members access to the general channel
 async function grantGeneralChannelAccess(serverId) {
  try {
    console.log("Granting all members access to general channel...");
    
    // Get all members in the server
    const membersRef = ref(db, `servers/${serverId}/members`);
    const membersSnapshot = await get(membersRef);
    
    if (!membersSnapshot.exists()) {
      console.log("No members found in server");
      return;
    }
    
    // Find the general channel
    const channelsRef = ref(db, `servers/${serverId}/channels`);
    const channelsSnapshot = await get(channelsRef);
    
    if (!channelsSnapshot.exists()) {
      console.log("No channels found in server");
      return;
    }
    
    let generalChannelId = null;
    channelsSnapshot.forEach((channelSnap) => {
      const channel = channelSnap.val();
      if (channel.name === "general") {
        generalChannelId = channelSnap.key;
      }
    });
    
    if (!generalChannelId) {
      console.log("General channel not found");
      return;
    }
    
    console.log("Found general channel:", generalChannelId);
    
    // Add all members to allowed members of general channel
    const allowedMembersRef = ref(db, `servers/${serverId}/channels/${generalChannelId}/allowedMembers`);
    
    const updates = {};
    membersSnapshot.forEach((memberSnap) => {
      const memberId = memberSnap.key;
      updates[memberId] = true;
    });
    
    await set(allowedMembersRef, updates);
    console.log("All members granted access to general channel");
    
  } catch (error) {
    console.error("Error granting general channel access:", error);
  }
 }

 // Function to load and display members for the current server
 async function loadServerMembers(serverId) {
  const membersList = document.getElementById("membersList");
  membersList.innerHTML = "";
  
  try {
    const membersRef = ref(db, `servers/${serverId}/members`);
    
    // Use onValue to listen for changes in the members list
    onValue(membersRef, async (snapshot) => {
      membersList.innerHTML = "";
      
      if (!snapshot.exists()) {
        membersList.innerHTML = "<p style='color: #aaa; text-align: center;'>No members found.</p>";
        return;
      }
      
      // Get server data to identify owner
      const serverRef = ref(db, `servers/${serverId}`);
      const serverSnapshot = await get(serverRef);
      const server = serverSnapshot.val();
      
      const members = [];
      
      snapshot.forEach((memberSnap) => {
        const memberId = memberSnap.key;
        const memberData = memberSnap.val();
        
        // Extract username and role
        let username = memberData;
        let role = "member";
        
        if (typeof memberData === "object") {
          username = memberData.username || "Unknown";
          role = memberData.role || "member";
        }
        
        // For owner role, check if this member is the creator
        if (memberId === server.createdBy) {
          role = "owner";
        }
        
        members.push({
          id: memberId,
          username,
          role
        });
      });
      
      // Sort members by role: owner first, then admins, then regular members
      members.sort((a, b) => {
        const roleOrder = { owner: 0, admin: 1, member: 2 };
        return roleOrder[a.role] - roleOrder[b.role];
      });
      
      // Display members
      members.forEach(member => {
        const memberItem = document.createElement("div");
        memberItem.className = "member-item";
        
        const memberName = document.createElement("span");
        memberName.className = "member-name";
        memberName.textContent = member.username;
        
        const memberRole = document.createElement("span");
        memberRole.className = `member-role role-${member.role}`;
        memberRole.textContent = member.role;
        
        memberItem.appendChild(memberName);
        memberItem.appendChild(memberRole);
        membersList.appendChild(memberItem);
      });
    });
  } catch (error) {
    console.error("Error loading members:", error);
    membersList.innerHTML = "<p style='color: red; text-align: center;'>Error loading members.</p>";
  }
 }

 // Load servers from database
 async function loadServers() {
 const serverList = document.getElementById("serverList");
 serverList.innerHTML = "";
 try {
 const serversRef = ref(db, "servers");
 const snapshot = await get(serversRef);
 if (snapshot.exists()) {
 const servers = [];
 snapshot.forEach((childSnapshot) => {
 const server = {
 id: childSnapshot.key,
 ...childSnapshot.val()
 };
 if (server.members && (server.members[currentUser.uid] || 
 (typeof server.members[currentUser.uid] === 'object' && 
 server.members[currentUser.uid].username))) {
 servers.push(server);
 }
 });
 displayServers(servers);
 } else {
 serverList.innerHTML = "<p>No servers found.</p>";
 }
 } catch (error) {
 console.error("‚ùå Error loading servers:", error);
 }
 }
 
 // Display servers in the server list
 function displayServers(servers) {
 const serverList = document.getElementById("serverList");
 serverList.innerHTML = servers.length === 0 
 ? "<p>No servers available. Create one!</p>"
 : "";
 
 servers.forEach(server => {
 const serverDiv = document.createElement("div");
 serverDiv.className = "server";
 serverDiv.textContent = server.name;
 serverDiv.addEventListener("click", () => selectServer(server));
 serverList.appendChild(serverDiv);
 });
 }
 
 // Select a server
 async function selectServer(server) {
  selectedServer = server;
  currentServerNameEl.textContent = server.name;
  
  // Switch to channel view and show members sidebar
  serverSectionView.style.display = "none";
  channelSectionView.style.display = "flex";
  membersSidebar.style.display = "flex";
  
  // Make selectedServer available globally
  window.selectedServer = server;
  
  // Check user role and update UI accordingly
  const userRole = await getCurrentUserRole(server.id, currentUser.uid);
  updateUIBasedOnRole(userRole);
  
  // Update dropdown options for regular members if needed
  updateDropdownForRegularMembers(userRole);
  
  // Explicitly ensure settings button is visible regardless of role
  document.getElementById("settingsButton").style.display = "block";
  
  // Grant all members access to general channel
  await grantGeneralChannelAccess(server.id);
  
  // Load members for this server
  loadServerMembers(server.id);
  
  // Load channels for this server
  loadChannels(server.id);
 }
 
 // Load channels for a specific server
 async function loadChannels(serverId) {
  const channelList = document.getElementById("channelList");
  channelList.innerHTML = "";
  try {
    const channelsRef = ref(db, `servers/${serverId}/channels`);
    const snapshot = await get(channelsRef);
    
    if (snapshot.exists()) {
      const channels = [];
      
      snapshot.forEach((childSnapshot) => {
        const channel = {
          id: childSnapshot.key,
          ...childSnapshot.val()
        };
        
        // Add all channels regardless of access
        channels.push(channel);
      });
      
      displayChannels(channels);
      console.log("All channels loaded:", channels);
    } else {
      console.log("No channels found for server:", serverId);
      channelList.innerHTML = "<p>No channels found in this server.</p>";
    }
  } catch (error) {
    console.error("‚ùå Error loading channels:", error);
    channelList.innerHTML = "<p>Error loading channels.</p>";
  }
 }
 
 // Display channels in the channel list
 function displayChannels(channels) {
  const channelList = document.getElementById("channelList");
  channelList.innerHTML = channels.length === 0 
    ? "<p>No channels available.</p>"
    : "";
  
  channels.forEach(channel => {
    const channelDiv = document.createElement("div");
    channelDiv.className = "channel";
    channelDiv.textContent = channel.name;
    channelDiv.addEventListener("click", () => joinChannel(channel));
    channelList.appendChild(channelDiv);
  });
 }
 
 // Check if user can access a channel
 async function canAccessChannel(serverId, channelId, userId) {
    // Owners and admins always have access
    const userRole = await getCurrentUserRole(serverId, userId);
    if (userRole === "owner" || userRole === "admin") {
        return true;
    }
    
    // For regular members, check allowedMembers
    const allowedRef = ref(db, `servers/${serverId}/channels/${channelId}/allowedMembers/${userId}`);
    const allowedSnapshot = await get(allowedRef);
    return allowedSnapshot.exists();
}

 // Join a channel
 async function joinChannel(channel) {
  selectedChannel = channel;
  window.selectedChannel = channel;
  
  // Check if user has access before loading messages
  const hasAccess = await canAccessChannel(selectedServer.id, channel.id, currentUser.uid);
  
  document.getElementById("chatChannelName").textContent = `#${channel.name} (${selectedServer.name})`;
  document.getElementById("messageInput").disabled = !hasAccess;
  
  if (!hasAccess) {
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #ff0000;">
      <h3>You don't have access to this channel</h3>
      <p>Please ask a server admin to grant you access.</p>
    </div>`;
    return;
  }
  
  loadMessages();
 }
 
 // Load messages for a channel
 async function loadMessages() {
 const messagesDiv = document.getElementById("messages");
 messagesDiv.innerHTML = "";
 
 if (!selectedServer || !selectedChannel) {
 return;
 }
 
 const messagesRef = ref(db, `servers/${selectedServer.id}/channels/${selectedChannel.id}/messages`);
 
 // Get current user role for permission checking
 const userRole = await getCurrentUserRole(selectedServer.id, currentUser.uid);
 console.log("Current user role for message deletion:", userRole);
 const canDeleteAnyMessage = userRole === "admin" || userRole === "owner";
 
 off(messagesRef); // Remove any existing listeners
 
 onChildAdded(messagesRef, (snapshot) => {
 const messageId = snapshot.key;
 const message = snapshot.val();
 
 // Create message container
 const messageElement = document.createElement("div");
 messageElement.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
 
 // Create message header
 const headerDiv = document.createElement("div");
 headerDiv.className = "message-header";
 headerDiv.textContent = message.senderName;
 
 // Create message text
 const textDiv = document.createElement("div");
 textDiv.className = "message-text";
 textDiv.textContent = message.text;
 
 // Create message time
 const timeDiv = document.createElement("div");
 timeDiv.className = "message-time";
 timeDiv.textContent = new Date(message.timestamp).toLocaleTimeString();
 
 // Add all elements to message container
 messageElement.appendChild(headerDiv);
 messageElement.appendChild(textDiv);
 messageElement.appendChild(timeDiv);
 
 // Check if user can delete this message
 const canDeleteThisMessage = canDeleteAnyMessage || message.senderId === currentUser.uid;
 
 if (canDeleteThisMessage) {
 const deleteBtn = document.createElement("button");
 deleteBtn.className = "delete-btn";
 deleteBtn.innerHTML = "&times;";
 deleteBtn.title = "Delete message";
 deleteBtn.setAttribute("data-message-id", messageId);
 
 deleteBtn.addEventListener("click", async (event) => {
 event.stopPropagation();
 
 // Confirm deletion
 if (confirm(`Are you sure you want to delete this message?`)) {
 try {
 // Get reference to the message
 const messageRef = ref(db, `servers/${selectedServer.id}/channels/${selectedChannel.id}/messages/${messageId}`);
 
 // Delete the message
 await remove(messageRef);
 
 console.log("Message deleted successfully");
 // Remove the message element directly instead of reloading all messages
 messageElement.remove();
 } catch (error) {
 console.error("Error deleting message:", error);
 alert("Failed to delete message.");
 }
 }
 });
 
 messageElement.appendChild(deleteBtn);
 }
 
 messagesDiv.appendChild(messageElement);
 messagesDiv.scrollTop = messagesDiv.scrollHeight;
 });
 }
 
 // Event listeners
 document.addEventListener("DOMContentLoaded", () => {
 const sendMessageBtn = document.getElementById("sendMessage");
 const messageInput = document.getElementById("messageInput");
 const createServerBtn = document.getElementById("createServer");
 const createChannelBtn = document.getElementById("createChannel");
 const deleteChannelBtn = document.getElementById("deleteChannel");
 
 // Allow sending message with Enter key
 messageInput.addEventListener("keydown", async (event) => {
  if (event.key === "Enter") {
    // Add the same access check as sendMessageBtn
    if (!selectedServer || !selectedChannel) return;
    
    try {
      const allowed = await canAccessChannel(
        selectedServer.id,
        selectedChannel.id,
        currentUser.uid
      );
      
      if (!allowed) {
        alert("‚ùå You don't have access to this channel");
        return;
      }
      sendMessageBtn.click();
    } catch (error) {
      console.error("Error checking access:", error);
    }
  }
});
 
 // Server popup elements
 const createServerPopUp = document.getElementById("createServerPopUp");
 const closeCreateServerBtn = document.getElementById("closeCreateServerPopUp");
 const confirmCreateServerBtn = document.getElementById("confirmCreateServer");
 
 // Channel popup elements
 const createChannelPopUp = document.getElementById("createChannelPopUp");
 const closeCreateChannelBtn = document.getElementById("closeCreateChannelPopUp");
 const confirmCreateChannelBtn = document.getElementById("confirmCreateChannel");
 
 // Member management
 const addMemberBtn = document.getElementById("addMember");
 const manageMembersBtn = document.getElementById("manageMembers");
 const leaveServerBtn = document.getElementById("leaveServer");
 const addMemberPopUp = document.getElementById("addMemberPopUp");
 const closeAddMemberBtn = document.getElementById("closeAddMemberPopUp");
 const confirmAddMemberBtn = document.getElementById("confirmAddMember");
 
 // Back button
 backToServersBtn.addEventListener("click", () => {
 serverSectionView.style.display = "block";
 channelSectionView.style.display = "none";
 membersSidebar.style.display = "none";
 document.getElementById("messages").innerHTML = "";
 document.getElementById("chatChannelName").textContent = "Select a server and channel to chat";
 document.getElementById("messageInput").disabled = true;
 selectedServer = null;
 selectedChannel = null;
 window.selectedServer = null;
 window.selectedChannel = null;
 });
 
 // Send message
 sendMessageBtn.addEventListener("click", async () => {
    const messageText = messageInput.value.trim();
    if (!messageText || !selectedServer || !selectedChannel) return;

    try {
        // Check if user still has channel access
        const allowed = await canAccessChannel(
            selectedServer.id,
            selectedChannel.id,
            currentUser.uid
        );
        
        if (!allowed) {
            alert("‚ùå You don't have access to this channel");
            return;
        }

        // Send message if access exists
        const messagesRef = ref(db, 
            `servers/${selectedServer.id}/channels/${selectedChannel.id}/messages`
            );
        await push(messagesRef, {
            text: messageText,
            senderId: currentUser.uid,
            senderName: currentUser.username,
            timestamp: Date.now()
        });
        messageInput.value = "";
    } catch (error) {
        console.error("‚ùå Error sending message:", error);
        alert("Failed to send message");
    }
});

 document.getElementById("manageChannelAccess").addEventListener("click", async () => {
    if (!selectedServer || !selectedChannel) {
        alert("Please select a server and channel first.");
        return;
    }

    try {
        const membersRef = ref(db, `servers/${selectedServer.id}/members`);
        const membersSnapshot = await get(membersRef);
        
        if (!membersSnapshot.exists()) {
            alert("No members found in this server.");
            return;
        }

        const allowedMembersRef = ref(db, `servers/${selectedServer.id}/channels/${selectedChannel.id}/allowedMembers`);
        const allowedSnapshot = await get(allowedMembersRef);

        const modal = document.createElement("div");
        modal.className = "popUp";
        modal.id = "channelAccessModal";
        modal.style.display = "flex";

        const modalContent = document.createElement("div");
        modalContent.className = "popUp-content";
        modalContent.style.width = "400px";

        const closeButton = document.createElement("span");
        closeButton.className = "close-button";
        closeButton.innerHTML = "&times;";
        closeButton.onclick = () => document.body.removeChild(modal);

        const title = document.createElement("h2");
        title.textContent = "Manage Channel Access";

        const membersList = document.createElement("div");
        membersList.style.textAlign = "left";

        membersSnapshot.forEach((memberSnap) => {
            const memberId = memberSnap.key;
            const memberData = memberSnap.val();
            const username = typeof memberData === 'object' ? memberData.username : memberData;
            const role = typeof memberData === 'object' ? memberData.role || "member" : "member";

            // Skip admins and owners as they always have access
            if (role === "admin" || memberId === selectedServer.createdBy) {
                return;
            }

            const memberItem = document.createElement("div");
            memberItem.style.padding = "10px";
            memberItem.style.margin = "10px 0";
            memberItem.style.backgroundColor = "#f1f1f1";
            memberItem.style.borderRadius = "5px";
            memberItem.style.display = "flex";
            memberItem.style.justifyContent = "space-between";
            memberItem.style.alignItems = "center";

            const memberInfo = document.createElement("div");
            memberInfo.innerHTML = `<strong>${username}</strong>`;

            const actionBtn = document.createElement("button");
            actionBtn.style.padding = "5px 10px";
            actionBtn.style.borderRadius = "3px";
            actionBtn.style.cursor = "pointer";

            const isAllowed = allowedSnapshot.exists() && allowedSnapshot.hasChild(memberId);
            if (isAllowed) {
                actionBtn.textContent = "Remove Access";
                actionBtn.style.backgroundColor = "#f44336";
                actionBtn.onclick = async () => {
                    await remove(ref(db, `servers/${selectedServer.id}/channels/${selectedChannel.id}/allowedMembers/${memberId}`));
                    modal.remove();
                    document.getElementById("manageChannelAccess").click();
                };
            } else {
                actionBtn.textContent = "Allow Access";
                actionBtn.style.backgroundColor = "#4CAF50";
                actionBtn.onclick = async () => {
                    await set(ref(db, `servers/${selectedServer.id}/channels/${selectedChannel.id}/allowedMembers/${memberId}`), true);
                    modal.remove();
                    document.getElementById("manageChannelAccess").click();
                };
            }

            memberItem.appendChild(memberInfo);
            memberItem.appendChild(actionBtn);
            membersList.appendChild(memberItem);
        });

        modalContent.appendChild(closeButton);
        modalContent.appendChild(title);
        modalContent.appendChild(membersList);
        modal.appendChild(modalContent);
        document.body.appendChild(modal);

    } catch (error) {
        console.error("Error managing channel access:", error);
        alert("Failed to load channel access management.");
    }
});
 
 // Create server
 createServerBtn.addEventListener("click", () => {
 createServerPopUp.style.display = "flex";
 });
 
 closeCreateServerBtn.addEventListener("click", () => {
 createServerPopUp.style.display = "none";
 });
 
 confirmCreateServerBtn.addEventListener("click", async () => {
    const serverName = document.getElementById("serverNameInput").value.trim();
    if (!serverName) {
        alert("Please enter a server name.");
        return;
    }
    
    try {
        const serversRef = ref(db, "servers");
        const newServerRef = push(serversRef);
        const newServerId = newServerRef.key;
        
        await set(newServerRef, {
            name: serverName,
            createdBy: currentUser.uid,
            createdAt: Date.now(),
            members: {
                [currentUser.uid]: {
                    username: currentUser.username,
                    role: "owner"
                }
            }
        });
        
        // Create a default "general" channel with access for all members
        const channelsRef = ref(db, `servers/${newServerId}/channels`);
        const generalChannelRef = push(channelsRef);
        await set(generalChannelRef, {
            name: "general",
            createdBy: currentUser.uid,
            createdAt: Date.now(),
            allowedMembers: {
                [currentUser.uid]: true  // Owner always has access
            }
        });
        
        alert(`‚úÖ Server "${serverName}" created successfully!`);
        createServerPopUp.style.display = "none";
        document.getElementById("serverNameInput").value = "";
        loadServers();
    } catch (error) {
        console.error("‚ùå Error creating server:", error);
        alert("Failed to create server.");
    }
});
 
 // Create channel
 createChannelBtn.addEventListener("click", async () => {
 if (!selectedServer) {
 alert("‚ùå Please select a server first.");
 return;
 }
 
 // Check user role
 const userRole = await getCurrentUserRole(selectedServer.id, currentUser.uid);
 if (userRole !== "admin" && userRole !== "owner") {
 alert("‚ùå Only admins and owners can create channels.");
 return;
 }
 
 createChannelPopUp.style.display = "flex";
 });
 
 closeCreateChannelBtn.addEventListener("click", () => {
 createChannelPopUp.style.display = "none";
 });
 
 confirmCreateChannelBtn.addEventListener("click", async () => {
    const channelName = document.getElementById("channelNameInput").value.trim();
    if (!channelName) {
        alert("Please enter a channel name.");
        return;
    }
    
    if (!selectedServer) {
        alert("‚ùå No server selected.");
        return;
    }
    
    // Double-check user role
    const userRole = await getCurrentUserRole(selectedServer.id, currentUser.uid);
    if (userRole !== "admin" && userRole !== "owner") {
        alert("‚ùå Only admins and owners can create channels.");
        return;
    }
    
    try {
        const channelsRef = ref(db, `servers/${selectedServer.id}/channels`);
        await push(channelsRef, {
            name: channelName,
            createdBy: currentUser.uid,
            createdAt: Date.now(),
            allowedMembers: {
                [currentUser.uid]: true // Creator always has access
            }
        });
        
        alert(`‚úÖ Channel "${channelName}" created successfully!`);
        createChannelPopUp.style.display = "none";
        document.getElementById("channelNameInput").value = "";
        
        // Reload channels to show the newly created one
        loadChannels(selectedServer.id);
    } catch (error) {
        console.error("‚ùå Error creating channel:", error);
        alert("Failed to create channel.");
    }
});
 
 // Delete channel
 deleteChannelBtn.addEventListener("click", async () => {
 if (!selectedServer || !selectedChannel) {
 alert("‚ùå Please select a server and channel first.");
 return;
 }
 
 // Check user role
 const userRole = await getCurrentUserRole(selectedServer.id, currentUser.uid);
 if (userRole !== "admin" && userRole !== "owner") {
 alert("‚ùå Only admins and owners can delete channels.");
 return;
 }
 
 const confirmDelete = confirm(`Are you sure you want to delete the channel "${selectedChannel.name}"?`);
 if (confirmDelete) {
 try {
 const channelRef = ref(db, `servers/${selectedServer.id}/channels/${selectedChannel.id}`);
 await remove(channelRef);
 
 alert(`‚úÖ Channel "${selectedChannel.name}" deleted successfully!`);
 
 // Reset view
 document.getElementById("messages").innerHTML = "";
 document.getElementById("chatChannelName").textContent = "Select a channel to chat";
 document.getElementById("messageInput").disabled = true;
 selectedChannel = null;
 window.selectedChannel = null;
 
 // Reload channels
 loadChannels(selectedServer.id);
 } catch (error) {
 console.error("‚ùå Error deleting channel:", error);
 alert("Failed to delete channel.");
 }
 }
 });
 
 // Add member
 addMemberBtn.addEventListener("click", async () => {
 if (!selectedServer) {
 alert("‚ùå Please select a server first.");
 return;
 }
 
 addMemberPopUp.style.display = "flex";
 });
 
 closeAddMemberBtn.addEventListener("click", () => {
 addMemberPopUp.style.display = "none";
 });
 
 confirmAddMemberBtn.addEventListener("click", async () => {
    const username = document.getElementById("memberUsernameInput").value.trim();
    if (!username) {
        alert("Please enter a username.");
        return;
    }
    
    if (!selectedServer) {
        alert("‚ùå No server selected.");
        return;
    }
    
    try {
        const usersSnapshot = await get(ref(db, "users"));
        let userFound = false;
        let addedUserId = null;
        
        usersSnapshot.forEach((userSnap) => {
            const user = userSnap.val();
            if (user.username === username) {
                userFound = true;
                addedUserId = userSnap.key;
                set(ref(db, `servers/${selectedServer.id}/members/${userSnap.key}`), {
                    username: username,
                    role: "member"
                });
            }
        });
        
        if (userFound && addedUserId) {
            // Grant access to the general channel for the new member
            // Find the general channel
            const channelsSnapshot = await get(ref(db, `servers/${selectedServer.id}/channels`));
            channelsSnapshot.forEach((channelSnap) => {
                const channel = channelSnap.val();
                if (channel.name === "general") {
                    // Add member to allowed members of general channel
                    set(ref(db, `servers/${selectedServer.id}/channels/${channelSnap.key}/allowedMembers/${addedUserId}`), true);
                }
            });
            
            alert(`‚úÖ ${username} was added to ${selectedServer.name} successfully!`);
            addMemberPopUp.style.display = "none";
            document.getElementById("memberUsernameInput").value = "";
        } else {
            alert("‚ùå User not found.");
        }
    } catch (error) {
        console.error("‚ùå Error adding member:", error);
        alert("Failed to add member.");
    }
});
 
 // Manage Members
 manageMembersBtn.addEventListener("click", async function() {
    if (!window.selectedServer) {
        alert("‚ùå Please select a server first.");
        document.getElementById("settingsDropdown").style.display = "none";
        return;
    }
    
    try {
        const serverId = window.selectedServer.id;
        
        // Get current user role (to check permissions)
        const currentUserId = auth.currentUser.uid;
        const userRole = await getCurrentUserRole(serverId, currentUserId);
        
        // Get members
        const membersRef = ref(db, `servers/${serverId}/members`);
        const membersSnapshot = await get(membersRef);
        
        if (!membersSnapshot.exists()) {
            alert("‚ùå No members found in this server.");
            document.getElementById("settingsDropdown").style.display = "none";
            return;
        }
        
        // Create modal
        const modal = document.createElement("div");
        modal.className = "popUp";
        modal.id = "memberManagementModal";
        modal.style.display = "flex";
        
        // Create modal content
        const modalContent = document.createElement("div");
        modalContent.className = "popUp-content";
        modalContent.style.width = "400px";
        modalContent.style.maxHeight = "80vh";
        modalContent.style.overflowY = "auto";
        
        // Add close button
        const closeButton = document.createElement("span");
        closeButton.className = "close-button";
        closeButton.innerHTML = "&times;";
        closeButton.onclick = () => document.body.removeChild(modal);
        
        // Add title
        const title = document.createElement("h2");
        title.textContent = "Manage Server Members";
        title.style.marginBottom = "20px";
        
        // Add members list
        const membersList = document.createElement("div");
        membersList.style.textAlign = "left";
        
        // Get server data to identify owner
        const serverRef = ref(db, `servers/${serverId}`);
        const serverSnapshot = await get(serverRef);
        const server = serverSnapshot.val();
        
        // Populate members list
        membersSnapshot.forEach((memberSnap) => {
            const memberId = memberSnap.key;
            const memberData = memberSnap.val();
            
            // Extract username and role
            let username = memberData;
            let role = "member";
            
            if (typeof memberData === "object") {
                username = memberData.username || "Unknown";
                role = memberData.role || "member";
            }
            
            // For owner role, check if this member is the creator
            if (memberId === server.createdBy) {
                role = "owner";
            }
            
            // Create member item
            const memberItem = document.createElement("div");
            memberItem.style.padding = "10px";
            memberItem.style.margin = "10px 0";
            memberItem.style.backgroundColor = "#f1f1f1";
            memberItem.style.borderRadius = "5px";
            memberItem.style.display = "flex";
            memberItem.style.justifyContent = "space-between";
            memberItem.style.alignItems = "center";
            
            // Member info
            const memberInfo = document.createElement("div");
            memberInfo.innerHTML = `
                <strong>${username}</strong>
                <span style="margin-left: 10px; padding: 2px 6px; background: ${
                role === "owner" ? "#ff9800" : 
                role === "admin" ? "#4CAF50" : "#2196F3"
                }; color: white; border-radius: 3px; font-size: 12px;">
                ${role}
                </span>
            `;
            
            // Action buttons
            const actionButtons = document.createElement("div");
            actionButtons.style.display = "flex";
            actionButtons.style.gap = "5px";
            
            // Only show actions if current user has proper permissions
            // Owner can do everything
            if (userRole === "owner" && memberId !== currentUserId) {
                // Transfer ownership button (for any member)
                const transferOwnershipBtn = document.createElement("button");
                transferOwnershipBtn.textContent = "Make Owner";
                transferOwnershipBtn.style.backgroundColor = "#FF9800";
                transferOwnershipBtn.style.color = "white";
                transferOwnershipBtn.style.border = "none";
                transferOwnershipBtn.style.padding = "5px 10px";
                transferOwnershipBtn.style.borderRadius = "3px";
                transferOwnershipBtn.style.cursor = "pointer";
                transferOwnershipBtn.style.fontSize = "12px";
                
                transferOwnershipBtn.onclick = async () => {
                    try {
                        if (confirm(`Are you sure you want to transfer ownership of "${server.name}" to ${username}? You will become an admin.`)) {
                            // Update the selected member to owner
                            await set(ref(db, `servers/${serverId}/members/${memberId}`), {
                                username: username,
                                role: "owner"
                            });
                            
                            // Update current owner to admin
                            await set(ref(db, `servers/${serverId}/members/${currentUserId}`), {
                                username: currentUser.username,
                                role: "admin"
                            });
                            
                            // Update server creator field
                            await set(ref(db, `servers/${serverId}/createdBy`), memberId);
                            
                            alert(`‚úÖ Ownership of "${server.name}" has been transferred to ${username}.`);
                            document.body.removeChild(modal);
                            
                            // Reset the view and go back to server list
                            serverSectionView.style.display = "block";
                            channelSectionView.style.display = "none";
                            membersSidebar.style.display = "none";
                            document.getElementById("messages").innerHTML = "";
                            document.getElementById("chatChannelName").textContent = "Select a server and channel to chat";
                            document.getElementById("messageInput").disabled = true;
                            selectedServer = null;
                            selectedChannel = null;
                            window.selectedServer = null;
                            window.selectedChannel = null;
                            
                            // Reload servers
                            loadServers();
                        }
                    } catch (error) {
                        console.error("Error transferring ownership:", error);
                        alert("Failed to transfer ownership. See console for details.");
                    }
                };
                
                actionButtons.appendChild(transferOwnershipBtn);
                
                // Promote button (for members)
                if (role === "member") {
                    const promoteBtn = document.createElement("button");
                    promoteBtn.textContent = "Promote";
                    promoteBtn.style.backgroundColor = "#4CAF50";
                    promoteBtn.style.color = "white";
                    promoteBtn.style.border = "none";
                    promoteBtn.style.padding = "5px 10px";
                    promoteBtn.style.borderRadius = "3px";
                    promoteBtn.style.cursor = "pointer";
                    promoteBtn.style.fontSize = "12px";
                    
                    promoteBtn.onclick = async () => {
                        try {
                            // Store both username and role
                            await set(ref(db, `servers/${serverId}/members/${memberId}`), {
                                username: username,
                                role: "admin"
                            });
                            
                            alert(`‚úÖ ${username} has been promoted to admin!`);
                            document.body.removeChild(modal);
                            // Re-open the modal to refresh
                            manageMembersBtn.click();
                        } catch (error) {
                            console.error("Error promoting member:", error);
                            alert("Failed to promote member. See console for details.");
                        }
                    };
                    
                    actionButtons.appendChild(promoteBtn);
                }
                
                // Demote button (for admins)
                if (role === "admin") {
                    const demoteBtn = document.createElement("button");
                    demoteBtn.textContent = "Demote";
                    demoteBtn.style.backgroundColor = "#f44336";
                    demoteBtn.style.color = "white";
                    demoteBtn.style.border = "none";
                    demoteBtn.style.padding = "5px 10px";
                    demoteBtn.style.borderRadius = "3px";
                    demoteBtn.style.cursor = "pointer";
                    demoteBtn.style.fontSize = "12px";
                    
                    demoteBtn.onclick = async () => {
                        try {
                            // Store both username and role
                            await set(ref(db, `servers/${serverId}/members/${memberId}`), {
                                username: username,
                                role: "member"
                            });
                            
                            alert(`‚úÖ ${username} has been demoted to member!`);
                            document.body.removeChild(modal);
                            // Re-open the modal to refresh
                            manageMembersBtn.click();
                        } catch (error) {
                            console.error("Error demoting member:", error);
                            alert("Failed to demote member. See console for details.");
                        }
                    };
                    
                    actionButtons.appendChild(demoteBtn);
                }
                
                // Remove button (for all except owner)
                if (role !== "owner") {
                    const removeBtn = document.createElement("button");
                    removeBtn.textContent = "Remove";
                    removeBtn.style.backgroundColor = "#9e9e9e";
                    removeBtn.style.color = "white";
                    removeBtn.style.border = "none";
                    removeBtn.style.padding = "5px 10px";
                    removeBtn.style.borderRadius = "3px";
                    removeBtn.style.cursor = "pointer";
                    removeBtn.style.fontSize = "12px";
                    
                    removeBtn.onclick = async () => {
                        try {
                            if (confirm(`Are you sure you want to remove ${username} from the server?`)) {
                                await remove(ref(db, `servers/${serverId}/members/${memberId}`));
                                alert(`‚úÖ ${username} has been removed from the server!`);
                                document.body.removeChild(modal);
                                // Re-open the modal to refresh
                                manageMembersBtn.click();
                            }
                        } catch (error) {
                            console.error("Error removing member:", error);
                            alert("Failed to remove member. See console for details.");
                        }
                    };
                    
                    actionButtons.appendChild(removeBtn);
                }
            } 
            // Admin can remove regular members, but not other admins or owner
            else if (userRole === "admin" && role === "member" && memberId !== currentUserId) {
                const removeBtn = document.createElement("button");
                removeBtn.textContent = "Remove";
                removeBtn.style.backgroundColor = "#9e9e9e";
                removeBtn.style.color = "white";
                removeBtn.style.border = "none";
                removeBtn.style.padding = "5px 10px";
                removeBtn.style.borderRadius = "3px";
                removeBtn.style.cursor = "pointer";
                removeBtn.style.fontSize = "12px";
                
                removeBtn.onclick = async () => {
                    try {
                        if (confirm(`Are you sure you want to remove ${username} from the server?`)) {
                            await remove(ref(db, `servers/${serverId}/members/${memberId}`));
                            alert(`‚úÖ ${username} has been removed from the server!`);
                            document.body.removeChild(modal);
                            // Re-open the modal to refresh
                            manageMembersBtn.click();
                        }
                    } catch (error) {
                        console.error("Error removing member:", error);
                        alert("Failed to remove member. See console for details.");
                    }
                };
                
                actionButtons.appendChild(removeBtn);
            }
            
            memberItem.appendChild(memberInfo);
            memberItem.appendChild(actionButtons);
            membersList.appendChild(memberItem);
        });
        
        // Assemble modal
        modalContent.appendChild(closeButton);
        modalContent.appendChild(title);
        modalContent.appendChild(membersList);
        modal.appendChild(modalContent);
        
        // Add to page
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error("Error showing member management:", error);
        alert("‚ùå Failed to load member management. See console for details.");
    }
    
    document.getElementById("settingsDropdown").style.display = "none";
});
// Leave server functionality
leaveServerBtn.addEventListener("click", async function() {
    if (!window.selectedServer) {
        alert("‚ùå Please select a server first.");
        return;
    }
    
    const serverId = window.selectedServer.id;
    const userId = auth.currentUser.uid;
    
    try {
        // Get user role
        const userRole = await getCurrentUserRole(serverId, userId);
        
        // Check if user is owner - owners should not be able to directly leave
        if (userRole === "owner") {
            alert("‚ùå As the server owner, you must transfer ownership before leaving the server.");
            return;
        }
        
        // Confirm leaving
        const confirmLeave = confirm(`Are you sure you want to leave the server "${window.selectedServer.name}"?`);
        if (!confirmLeave) {
            return;
        }
        
        // Remove the user from the server members
        await remove(ref(db, `servers/${serverId}/members/${userId}`));
        
        alert(`‚úÖ You have left the server "${window.selectedServer.name}".`);
        
        // Reset view and go back to server list
        serverSectionView.style.display = "block";
        channelSectionView.style.display = "none";
        membersSidebar.style.display = "none";
        document.getElementById("messages").innerHTML = "";
        document.getElementById("chatChannelName").textContent = "Select a server and channel to chat";
        document.getElementById("messageInput").disabled = true;
        selectedServer = null;
        selectedChannel = null;
        window.selectedServer = null;
        window.selectedChannel = null;
        
        // Reload servers
        loadServers();
    } catch (error) {
        console.error("‚ùå Error leaving server:", error);
        alert("Failed to leave server. See console for details.");
    }
    
    document.getElementById("settingsDropdown").style.display = "none";
});
 
 // Delete server
 const deleteServerBtn = document.getElementById("deleteServer");
 if (deleteServerBtn) {
 deleteServerBtn.addEventListener("click", async () => {
 if (!selectedServer) {
 alert("‚ùå Please select a server first.");
 return;
 }
 
 // Check if user is owner
 const userRole = await getCurrentUserRole(selectedServer.id, currentUser.uid);
 if (userRole !== "owner") {
 alert("‚ùå Only the server owner can delete the server.");
 return;
 }
 
 const confirmDelete = confirm(`Are you sure you want to delete the server "${selectedServer.name}"? This action cannot be undone.`);
 if (confirmDelete) {
 try {
 const serverRef = ref(db, `servers/${selectedServer.id}`);
 await remove(serverRef);
 
 alert(`‚úÖ Server "${selectedServer.name}" deleted successfully!`);
 
 // Reset view and go back to server list
 serverSectionView.style.display = "block";
 channelSectionView.style.display = "none";
 membersSidebar.style.display = "none";
 document.getElementById("messages").innerHTML = "";
 document.getElementById("chatChannelName").textContent = "Select a server and channel to chat";
 document.getElementById("messageInput").disabled = true;
 selectedServer = null;
 selectedChannel = null;
 window.selectedServer = null;
 window.selectedChannel = null;
 
 // Reload servers
 loadServers();
 } catch (error) {
 console.error("‚ùå Error deleting server:", error);
 alert("Failed to delete server.");
 }
 }
 });
 }
 });

 // Logout
 document.getElementById("logoutButton").addEventListener("click", function () {
 console.log("üöÄ Logout button clicked!");

 signOut(auth).then(() => {
 console.log("‚úÖ User logged out. Redirecting...");
 window.top.location.href = "../../Sprint1/LoginPage/user_login.html";
 }).catch((error) => {
 console.error("‚ùå Logout failed:", error);
 });
 });

 // Make variables available globally
 window.selectedServer = selectedServer;
 window.selectedChannel = selectedChannel;
 window.getCurrentUserRole = getCurrentUserRole;
 window.canAccessChannel = canAccessChannel;
 window.grantGeneralChannelAccess = grantGeneralChannelAccess;
 </script>
 <script type="module" src="./memberHandler.js"></script>
</body>
</html>
