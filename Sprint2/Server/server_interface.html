<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatHaven - Servers & Channels</title>
    <link rel="stylesheet" href="./server.css">
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Server Section -->
            <div class="server-section" id="serverSectionView">
                <h2>Servers</h2>
                <input type="text" id="searchServer" placeholder="Search for a server...">
                <button id="createServer">+ Create Server</button>
                <div id="serverList"></div>
            </div>

            <!-- Channel Section (hidden initially) -->
            <div class="channel-section" id="channelSectionView">
                <button class="back-button" id="backToServers">‚Üê Back to Servers</button>
                <h2 id="currentServerName">Server Name</h2>
                <div class="divider"></div>
                <h3>CHANNELS</h3>
                <input type="text" id="searchChannel" placeholder="Search for a channel...">
                <button id="createChannel">+ Create Channel</button>
                <div id="channelList"></div>
            </div>
        </div>

        <!-- Chat Box -->
        <div class="chat-box">
            <div class="chat-header">
                <h2 id="chatChannelName">Select a server and channel to chat</h2>
                <!-- Settings Button -->
                <div class="settings-container">
                    <button id="settingsButton">‚öô Settings</button>
                    <div class="dropdown-menu" id="settingsDropdown">
                        <button id="addMember">‚ûï Add Member</button>
                        <button id="removeMember">‚ûñ Remove Member</button>
                        <button id="viewMembers">üë• Current Members</button>
                        <button id="promoteToAdmin">‚≠ê Promote to Admin</button>
                        <button id="demoteToMember">‚¨á Demote to Member</button>
                        <button id="deleteServer">‚ùå Delete Server</button>
                    </div>
                </div>
            </div>

            <div id="messages"></div>
            <div class="message-input">
                <input type="text" id="messageInput" placeholder="Type a message...">
                <button id="sendMessage">Send</button>
            </div>
        </div>
    </div>

    <!-- Add Member Popup -->
    <div id="addMemberPopUp" class="popUp">
        <div class="popUp-content">
            <span class="close-button" id="closeAddMemberPopUp">&times;</span>
            <h2>Add Member</h2>
            <input type="text" id="memberUsernameInput" placeholder="Enter username">
            <button id="confirmAddMember">Add Member</button>
        </div>
    </div>

    <!-- Create Server Popup -->
    <div id="createServerPopUp" class="popUp">
        <div class="popUp-content">
            <span class="close-button" id="closeCreateServerPopUp">&times;</span>
            <h2>Create Server</h2>
            <input type="text" id="serverNameInput" placeholder="Enter server name">
            <button id="confirmCreateServer">Create Server</button>
        </div>
    </div>

    <!-- Create Channel Popup -->
    <div id="createChannelPopUp" class="popUp">
        <div class="popUp-content">
            <span class="close-button" id="closeCreateChannelPopUp">&times;</span>
            <h2>Create Channel</h2>
            <input type="text" id="channelNameInput" placeholder="Enter channel name">
            <button id="confirmCreateChannel">Create Channel</button>
        </div>
    </div>

    <button id="logoutButton">Logout</button>
    
    <!-- JS Files -->
    <script src="./settings.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, push, set, get, onChildAdded, off } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDFhghmxUfCJbnnOFsleHoatF7D-ubnLpU",
            authDomain: "project-8042491080443698183.firebaseapp.com",
            databaseURL: "https://project-8042491080443698183-default-rtdb.firebaseio.com",
            projectId: "project-8042491080443698183",
            storageBucket: "project-8042491080443698183.appspot.com",
            messagingSenderId: "583304911847",
            appId: "1:583304911847:web:8dfe3e5c016062dd457b42"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        // Make these variables global for access from other scripts
        window.currentUser = null;
        window.selectedServer = null;
        window.selectedChannel = null;
        window.db = db;
        
        // DOM Elements for Server & Channel Views
        const serverSectionView = document.getElementById("serverSectionView");
        const channelSectionView = document.getElementById("channelSectionView");
        const backToServersBtn = document.getElementById("backToServers");
        const currentServerNameEl = document.getElementById("currentServerName");
        
        // Initialize UI state
        function initializeUIState() {
            serverSectionView.style.display = "block";
            channelSectionView.style.display = "none";
            document.getElementById("chatChannelName").textContent = "Select a server and channel to chat";
            document.getElementById("messageInput").disabled = true;
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                const userRef = ref(db, `users/${user.uid}`);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    window.currentUser.username = snapshot.val().username;
                }
                console.log("‚úÖ Logged in as:", window.currentUser.username);
                loadServers();
                initializeUIState();
            } else {
                console.error("‚ùå No user detected. Redirecting...");
                window.location.href = "../LoginPage/user_login.html";
            }
        });
        
        // Load servers from database
        async function loadServers() {
            const serverList = document.getElementById("serverList");
            serverList.innerHTML = "";
            try {
                const serversRef = ref(db, "servers");
                const snapshot = await get(serversRef);
                if (snapshot.exists()) {
                    const servers = [];
                    snapshot.forEach((childSnapshot) => {
                        const server = {
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        };
                        if (server.members && server.members[window.currentUser.uid]) {
                            servers.push(server);
                        }
                    });
                    displayServers(servers);
                } else {
                    serverList.innerHTML = "<p>No servers found.</p>";
                }
            } catch (error) {
                console.error("‚ùå Error loading servers:", error);
            }
        }
        
        // Display servers in the server list
        function displayServers(servers) {
            const serverList = document.getElementById("serverList");
            serverList.innerHTML = servers.length === 0 
                ? "<p>No servers available. Create one!</p>"
                : "";
        
            servers.forEach(server => {
                const serverDiv = document.createElement("div");
                serverDiv.className = "server";
                serverDiv.textContent = server.name;
                serverDiv.addEventListener("click", () => selectServer(server));
                serverList.appendChild(serverDiv);
            });
        }
        
        // Select a server
        function selectServer(server) {
            window.selectedServer = server;
            currentServerNameEl.textContent = server.name;
            
            // Update UI based on user's role
            window.updateUIForRole(server.id, window.currentUser.uid);
            
            // Switch to channel view
            serverSectionView.style.display = "none";
            channelSectionView.style.display = "flex";
            
            // Load channels for this server
            loadChannels(server.id);
        }
        
        // Load channels for a specific server
        async function loadChannels(serverId) {
            const channelList = document.getElementById("channelList");
            channelList.innerHTML = "";
            try {
                const channelsRef = ref(db, `servers/${serverId}/channels`);
                const snapshot = await get(channelsRef);
                
                if (snapshot.exists()) {
                    const channels = [];
                    snapshot.forEach((childSnapshot) => {
                        const channel = {
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        };
                        channels.push(channel);
                    });
                    
                    displayChannels(channels);
                    console.log("Channels loaded:", channels);
                } else {
                    console.log("No channels found for server:", serverId);
                    channelList.innerHTML = "<p>No channels found in this server.</p>";
                }
            } catch (error) {
                console.error("‚ùå Error loading channels:", error);
                channelList.innerHTML = "<p>Error loading channels.</p>";
            }
        }
        
        // Display channels in the channel list
        function displayChannels(channels) {
            const channelList = document.getElementById("channelList");
            channelList.innerHTML = channels.length === 0 
                ? "<p>No channels available. Create one!</p>"
                : "";
        
            channels.forEach(channel => {
                const channelDiv = document.createElement("div");
                channelDiv.className = "channel";
                channelDiv.textContent = channel.name;
                channelDiv.addEventListener("click", () => joinChannel(channel));
                channelList.appendChild(channelDiv);
            });
        }
        
        // Join a channel
        function joinChannel(channel) {
            window.selectedChannel = channel;
            document.getElementById("chatChannelName").textContent = `#${channel.name} (${window.selectedServer.name})`;
            document.getElementById("messageInput").disabled = false;
            
            // Use the new message listener for real-time updates
            window.setupMessageListeners(window.selectedServer.id, channel.id);
        }
        
        // Event listeners
        document.addEventListener("DOMContentLoaded", () => {
            // Main buttons
            const sendMessageBtn = document.getElementById("sendMessage");
            const messageInput = document.getElementById("messageInput");
            const createServerBtn = document.getElementById("createServer");
            const createChannelBtn = document.getElementById("createChannel");
            
            // Allow sending message with Enter key
            messageInput.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    sendMessageBtn.click();
                }
            });
            
            // Server popup elements
            const createServerPopUp = document.getElementById("createServerPopUp");
            const closeCreateServerBtn = document.getElementById("closeCreateServerPopUp");
            const confirmCreateServerBtn = document.getElementById("confirmCreateServer");
            
            // Channel popup elements
            const createChannelPopUp = document.getElementById("createChannelPopUp");
            const closeCreateChannelBtn = document.getElementById("closeCreateChannelPopUp");
            const confirmCreateChannelBtn = document.getElementById("confirmCreateChannel");
            
            // Member management
            const addMemberBtn = document.getElementById("addMember");
            const removeMemberBtn = document.getElementById("removeMember");
            const addMemberPopUp = document.getElementById("addMemberPopUp");
            const closeAddMemberBtn = document.getElementById("closeAddMemberPopUp");
            
            // Back button
            backToServersBtn.addEventListener("click", () => {
                serverSectionView.style.display = "block";
                channelSectionView.style.display = "none";
                document.getElementById("messages").innerHTML = "";
                document.getElementById("chatChannelName").textContent = "Select a server and channel to chat";
                document.getElementById("messageInput").disabled = true;
                window.selectedServer = null;
                window.selectedChannel = null;
            });
            
            // Send message
            sendMessageBtn.addEventListener("click", () => {
                const messageText = messageInput.value.trim();
                if (messageText && window.selectedServer && window.selectedChannel) {
                    const messagesRef = ref(db, `servers/${window.selectedServer.id}/channels/${window.selectedChannel.id}/messages`);
                    push(messagesRef, {
                        text: messageText,
                        senderId: window.currentUser.uid,
                        senderName: window.currentUser.username,
                        timestamp: Date.now()
                    });
                    messageInput.value = "";
                }
            });
            
            // Create server
            createServerBtn.addEventListener("click", () => {
                createServerPopUp.style.display = "flex";
            });
            
            closeCreateServerBtn.addEventListener("click", () => {
                createServerPopUp.style.display = "none";
            });
            
            confirmCreateServerBtn.addEventListener("click", async () => {
                const serverName = document.getElementById("serverNameInput").value.trim();
                if (!serverName) {
                    alert("Please enter a server name.");
                    return;
                }
                
                try {
                    const serversRef = ref(db, "servers");
                    const newServerRef = push(serversRef);
                    const newServerId = newServerRef.key;
                    
                    await set(newServerRef, {
                        name: serverName,
                        createdBy: window.currentUser.uid,
                        createdAt: Date.now(),
                        members: {
                            [window.currentUser.uid]: {
                                username: window.currentUser.username,
                                role: "owner" // Set the creator as owner
                            }
                        }
                    });
                    
                    // Create a default "general" channel
                    const channelsRef = ref(db, `servers/${newServerId}/channels`);
                    await push(channelsRef, {
                        name: "general",
                        createdBy: window.currentUser.uid,
                        createdAt: Date.now()
                    });
                    
                    alert(`‚úÖ Server "${serverName}" created successfully!`);
                    createServerPopUp.style.display = "none";
                    document.getElementById("serverNameInput").value = "";
                    loadServers();
                } catch (error) {
                    console.error("‚ùå Error creating server:", error);
                    alert("Failed to create server.");
                }
            });
            
            // Create channel
            createChannelBtn.addEventListener("click", () => {
                if (!window.selectedServer) {
                    alert("‚ùå Please select a server first.");
                    return;
                }
                createChannelPopUp.style.display = "flex";
            });
            
            closeCreateChannelBtn.addEventListener("click", () => {
                createChannelPopUp.style.display = "none";
            });
            
            confirmCreateChannelBtn.addEventListener("click", async () => {
                const channelName = document.getElementById("channelNameInput").value.trim();
                if (!channelName) {
                    alert("Please enter a channel name.");
                    return;
                }
                
                if (!window.selectedServer) {
                    alert("‚ùå No server selected.");
                    return;
                }
                
                try {
                    const channelsRef = ref(db, `servers/${window.selectedServer.id}/channels`);
                    await push(channelsRef, {
                        name: channelName,
                        createdBy: window.currentUser.uid,
                        createdAt: Date.now()
                    });
                    
                    alert(`‚úÖ Channel "${channelName}" created successfully!`);
                    createChannelPopUp.style.display = "none";
                    document.getElementById("channelNameInput").value = "";
                    
                    // Reload channels to show the newly created one
                    loadChannels(window.selectedServer.id);
                } catch (error) {
                    console.error("‚ùå Error creating channel:", error);
                    alert("Failed to create channel.");
                }
            });
            
            // Add member
            addMemberBtn.addEventListener("click", () => {
                if (!window.selectedServer) {
                    alert("‚ùå Please select a server first.");
                    return;
                }
                addMemberPopUp.style.display = "flex";
            });
            
            closeAddMemberBtn.addEventListener("click", () => {
                addMemberPopUp.style.display = "none";
            });
            
            // Remove member functionality
            removeMemberBtn.addEventListener("click", async () => {
                if (!window.selectedServer) {
                    alert("‚ùå Please select a server first.");
                    return;
                }
                
                // Use the new displayMembers function to show a modal with remove options
                window.displayMembers(window.selectedServer.id);
            });
            
            // Delete server functionality
            const deleteServerBtn = document.getElementById("deleteServer");
            deleteServerBtn.addEventListener("click", async () => {
                if (!window.selectedServer) {
                    alert("‚ùå Please select a server first.");
                    return;
                }
                
                // Check if current user is owner
                const userRole = await window.getCurrentUserRole(window.selectedServer.id, window.currentUser.uid);
                if (userRole !== "owner") {
                    alert("‚ùå Only the owner can delete the server.");
                    return;
                }
                
                // Confirm deletion
                const confirmDelete = confirm(`Are you sure you want to delete the server "${window.selectedServer.name}"? This action cannot be undone.`);
                if (!confirmDelete) {
                    return;
                }
                
                try {
                    // Delete the server
                    await set(ref(db, `servers/${window.selectedServer.id}`), null);
                    
                    alert(`‚úÖ Server "${window.selectedServer.name}" has been deleted.`);
                    
                    // Return to servers view and reload
                    backToServersBtn.click();
                    loadServers();
                } catch (error) {
                    console.error("‚ùå Error deleting server:", error);
                    alert("Failed to delete server.");
                }
            });
        });

        //Logout
        document.getElementById("logoutButton").addEventListener("click", function () {
            console.log("üöÄ Logout button clicked!");

            signOut(auth).then(() => {
                console.log("‚úÖ User logged out. Redirecting...");
                window.top.location.href = "../../Sprint1/LoginPage/user_login.html";
            }).catch((error) => {
                console.error("‚ùå Logout failed:", error);
            });
        });
    </script>
    
    <!-- Import the updated currentMembers.js file -->
    <script type="module" src="./currentMembers.js"></script>
</body>
</html>
