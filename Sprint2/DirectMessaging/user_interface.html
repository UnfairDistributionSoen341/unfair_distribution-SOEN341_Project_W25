<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>ChatHaven - Direct Messages</title>
 <link rel="stylesheet" href="./dm.css">
 <style>
 .message .delete-button {
   cursor: pointer;
   color: red;
   font-size: 12px;
   margin-left: 10px;
 }
 #contextMenu {
   display: none;
   position: absolute;
   background-color: white;
   border: 1px solid #ccc;
   box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
   z-index: 1000;
 }
 #contextMenu ul {
   list-style: none;
   margin: 0;
   padding: 0;
 }
 #contextMenu li {
   padding: 8px 12px;
   cursor: pointer;
 }
 #contextMenu li:hover {
   background-color: #f1f1f1;
 }
 .modal {
   display: none;
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background-color: rgba(0, 0, 0, 0.5);
   justify-content: center;
   align-items: center;
   z-index: 1001;
 }
 .modal-content {
   background-color: white;
   padding: 20px;
   border-radius: 5px;
   width: 300px;
 }
 .modal-content textarea {
   width: 100%;
   height: 100px;
   margin-bottom: 10px;
 }
 #logoutButton {
   position: fixed;
   bottom: 20px;
   left: 20px;
   padding: 10px 20px;
   background-color: red;
   color: white;
   border: none;
   cursor: pointer;
   font-size: 16px;
   border-radius: 5px;
 }
 #logoutButton:hover {
   background-color: darkred;
 }
 
 /* Emoji Picker Styles */
 .emoji-container {
   position: relative;
   margin-right: 10px;
 }
 
 #emojiButton {
   cursor: pointer;
   background: none;
   border: none;
   font-size: 20px;
   padding: 10px;
   border-radius: 5px;
   transition: background 0.3s;
 }
 
 #emojiButton:hover {
   background-color: #f1f1f1;
 }
 
 #emojiPicker {
   position: absolute;
   bottom: 50px;
   left: 0;
   width: 300px;
   background: white;
   border: 1px solid #ddd;
   border-radius: 5px;
   box-shadow: 0 5px 15px rgba(0,0,0,0.2);
   z-index: 1000;
 }
 
 .emoji-tabs {
   display: flex;
   border-bottom: 1px solid #ddd;
 }
 
 .emoji-tab {
   flex: 1;
   padding: 10px;
   text-align: center;
   background: none;
   border: none;
   cursor: pointer;
 }
 
 .emoji-tab.active {
   background-color: #f1f1f1;
 }
 
 .emoji-content {
   max-height: 200px;
   overflow-y: auto;
   padding: 10px;
 }
 
 .emoji-category {
   display: none;
   flex-wrap: wrap;
   gap: 5px;
 }
 
 .emoji-category.active {
   display: flex;
 }
 
 .emoji {
   font-size: 20px;
   cursor: pointer;
   padding: 5px;
   border-radius: 5px;
 }
 
 .emoji:hover {
   background-color: #f1f1f1;
 }

 /* Message styles */
 .message .reply-button {
   background-color: #e1e1e1;
   border: none;
   border-radius: 3px;
   padding: 3px 8px;
   font-size: 12px;
   margin-right: 5px;
   cursor: pointer;
   display: none;
 }

 .message:hover .reply-button {
   display: inline-block;
 }

 .message .delete-btn {
   position: absolute;
   right: 10px;
   top: 10px;
   background: none;
   border: none;
   color: #ff5555;
   font-size: 18px;
   cursor: pointer;
   opacity: 0;
   transition: opacity 0.2s;
 }

 .message:hover .delete-btn {
   opacity: 1;
 }

 .status-indicator {
   margin-left: 8px;
   font-size: 12px;
   transition: opacity 0.3s;
 }

 .user-wrapper {
   display: flex;
   flex-direction: column;
   align-items: center;
   margin-right: 15px;
 }

 .message-container {
   display: flex;
   margin-bottom: 8px;
   position: relative;
 }

 .message-content {
   flex: 1;
 }

 .message-text {
   margin: 0 0 5px 0;
   word-break: break-word;
 }

 .message-timestamp {
   font-size: 12px;
   color: #888;
   text-align: right;
 }

 .message-profile {
   width: 40px;
   height: 40px;
   border-radius: 50%;
   object-fit: cover;
   margin-bottom: 4px;
 }

 .message-username {
   font-size: 12px;
   max-width: 60px;
   white-space: nowrap;
   overflow: hidden;
   text-overflow: ellipsis;
   text-align: center;
 }
 </style>
</head>
<body>
 <div class="chat-container">
   <div class="sidebar">
     <h2>Direct Messages</h2>
     <input type="text" id="searchUser" placeholder="Search for a user...">
     <div id="userList"></div>
   </div>

   <div class="chat-box">
     <h2 id="chatUserName">Select a user to chat</h2>
     <div id="messages"></div>
     <div class="message-input">
       <div class="emoji-container">
         <button id="emojiButton">😊</button>
         <div id="emojiPicker" style="display: none;">
           <div class="emoji-tabs">
             <button class="emoji-tab active" data-category="smileys">😀</button>
             <button class="emoji-tab" data-category="animals">🐱</button>
             <button class="emoji-tab" data-category="food">🍔</button>
             <button class="emoji-tab" data-category="symbols">❤️</button>
           </div>
           <div class="emoji-content">
             <div class="emoji-category active" id="smileys">
               <span class="emoji" data-emoji="😀">😀</span>
               <span class="emoji" data-emoji="😃">😃</span>
               <span class="emoji" data-emoji="😄">😄</span>
               <span class="emoji" data-emoji="😁">😁</span>
               <span class="emoji" data-emoji="😆">😆</span>
               <span class="emoji" data-emoji="😅">😅</span>
               <span class="emoji" data-emoji="🤣">🤣</span>
               <span class="emoji" data-emoji="😂">😂</span>
               <span class="emoji" data-emoji="🙂">🙂</span>
               <span class="emoji" data-emoji="🙃">🙃</span>
               <span class="emoji" data-emoji="😉">😉</span>
               <span class="emoji" data-emoji="😊">😊</span>
               <span class="emoji" data-emoji="😇">😇</span>
               <span class="emoji" data-emoji="🥰">🥰</span>
               <span class="emoji" data-emoji="😍">😍</span>
               <span class="emoji" data-emoji="🤩">🤩</span>
               <span class="emoji" data-emoji="😘">😘</span>
               <span class="emoji" data-emoji="😗">😗</span>
               <span class="emoji" data-emoji="😚">😚</span>
               <span class="emoji" data-emoji="😙">😙</span>
               <span class="emoji" data-emoji="🥲">🥲</span>
               <span class="emoji" data-emoji="😋">😋</span>
               <span class="emoji" data-emoji="😛">😛</span>
               <span class="emoji" data-emoji="😜">😜</span>
               <span class="emoji" data-emoji="🤪">🤪</span>
               <span class="emoji" data-emoji="😝">😝</span>
               <span class="emoji" data-emoji="🤑">🤑</span>
               <span class="emoji" data-emoji="🤗">🤗</span>
               <span class="emoji" data-emoji="🤭">🤭</span>
               <span class="emoji" data-emoji="🤫">🤫</span>
               <span class="emoji" data-emoji="🤔">🤔</span>
               <span class="emoji" data-emoji="🤤">🤤</span>
               <span class="emoji" data-emoji="🤐">🤐</span>
               <span class="emoji" data-emoji="🥴">🥴</span>
               <span class="emoji" data-emoji="😴">😴</span>
               <span class="emoji" data-emoji="🥱">🥱</span>
               <span class="emoji" data-emoji="😷">😷</span>
               <span class="emoji" data-emoji="🖕">🖕</span>
               <span class="emoji" data-emoji="💀">💀</span>
               <span class="emoji" data-emoji="💩">💩</span>
               <span class="emoji" data-emoji="🤢">🤢</span>
             </div>
             <div class="emoji-category" id="animals">
               <span class="emoji" data-emoji="🐶">🐶</span>
               <span class="emoji" data-emoji="🐱">🐱</span>
               <span class="emoji" data-emoji="🐭">🐭</span>
               <span class="emoji" data-emoji="🐹">🐹</span>
               <span class="emoji" data-emoji="🐰">🐰</span>
               <span class="emoji" data-emoji="🦊">🦊</span>
               <span class="emoji" data-emoji="🐻">🐻</span>
               <span class="emoji" data-emoji="🐼">🐼</span>
               <span class="emoji" data-emoji="🐨">🐨</span>
               <span class="emoji" data-emoji="🐯">🐯</span>
               <span class="emoji" data-emoji="🦁">🦁</span>
               <span class="emoji" data-emoji="🐮">🐮</span>
               <span class="emoji" data-emoji="🐷">🐷</span>
               <span class="emoji" data-emoji="🐸">🐸</span>
               <span class="emoji" data-emoji="🐵">🐵</span>
               <span class="emoji" data-emoji="🐔">🐔</span>
               <span class="emoji" data-emoji="🐧">🐧</span>
               <span class="emoji" data-emoji="🐦">🐦</span>
               <span class="emoji" data-emoji="🦄">🦄</span>
               <span class="emoji" data-emoji="🦇">🦇</span>
               <span class="emoji" data-emoji="🦉">🦉</span>
               <span class="emoji" data-emoji="🦋">🦋</span>
               <span class="emoji" data-emoji="🐝">🐝</span>
               <span class="emoji" data-emoji="🐢">🐢</span>
               <span class="emoji" data-emoji="🐙">🐙</span>
               <span class="emoji" data-emoji="🦑">🦑</span>
               <span class="emoji" data-emoji="🦞">🦞</span>
               <span class="emoji" data-emoji="🦀">🦀</span>
               <span class="emoji" data-emoji="🐬">🐬</span>
               <span class="emoji" data-emoji="🐳">🐳</span>
             </div>
             <div class="emoji-category" id="food">
               <span class="emoji" data-emoji="🍎">🍎</span>
               <span class="emoji" data-emoji="🍐">🍐</span>
               <span class="emoji" data-emoji="🍊">🍊</span>
               <span class="emoji" data-emoji="🍋">🍋</span>
               <span class="emoji" data-emoji="🍌">🍌</span>
               <span class="emoji" data-emoji="🍉">🍉</span>
               <span class="emoji" data-emoji="🍇">🍇</span>
               <span class="emoji" data-emoji="🍓">🍓</span>
               <span class="emoji" data-emoji="🍈">🍈</span>
               <span class="emoji" data-emoji="🍒">🍒</span>
               <span class="emoji" data-emoji="🍑">🍑</span>
               <span class="emoji" data-emoji="🥭">🥭</span>
               <span class="emoji" data-emoji="🍍">🍍</span>
               <span class="emoji" data-emoji="🥥">🥥</span>
               <span class="emoji" data-emoji="🥝">🥝</span>
               <span class="emoji" data-emoji="🍅">🍅</span>
               <span class="emoji" data-emoji="🍆">🍆</span>
               <span class="emoji" data-emoji="🥑">🥑</span>
               <span class="emoji" data-emoji="🥦">🥦</span>
               <span class="emoji" data-emoji="🥬">🥬</span>
               <span class="emoji" data-emoji="🥕">🥕</span>
               <span class="emoji" data-emoji="🌽">🌽</span>
               <span class="emoji" data-emoji="🌶️">🌶️</span>
               <span class="emoji" data-emoji="🥐">🥐</span>
               <span class="emoji" data-emoji="🍞">🍞</span>
               <span class="emoji" data-emoji="🥨">🥨</span>
               <span class="emoji" data-emoji="🍔">🍔</span>
               <span class="emoji" data-emoji="🍟">🍟</span>
               <span class="emoji" data-emoji="🍕">🍕</span>
               <span class="emoji" data-emoji="🌭">🌭</span>
               <span class="emoji" data-emoji="🍿">🍿</span>
               <span class="emoji" data-emoji="🧁">🧁</span>
               <span class="emoji" data-emoji="🍰">🍰</span>
               <span class="emoji" data-emoji="🍫">🍫</span>
               <span class="emoji" data-emoji="🍬">🍬</span>
             </div>
             <div class="emoji-category" id="symbols">
               <span class="emoji" data-emoji="❤️">❤️</span>
               <span class="emoji" data-emoji="🧡">🧡</span>
               <span class="emoji" data-emoji="💛">💛</span>
               <span class="emoji" data-emoji="💚">💚</span>
               <span class="emoji" data-emoji="💙">💙</span>
               <span class="emoji" data-emoji="💜">💜</span>
               <span class="emoji" data-emoji="🖤">🖤</span>
               <span class="emoji" data-emoji="🤍">🤍</span>
               <span class="emoji" data-emoji="🤎">🤎</span>
               <span class="emoji" data-emoji="💔">💔</span>
               <span class="emoji" data-emoji="❣️">❣️</span>
               <span class="emoji" data-emoji="💕">💕</span>
               <span class="emoji" data-emoji="💞">💞</span>
               <span class="emoji" data-emoji="💓">💓</span>
               <span class="emoji" data-emoji="💗">💗</span>
               <span class="emoji" data-emoji="💖">💖</span>
               <span class="emoji" data-emoji="💘">💘</span>
               <span class="emoji" data-emoji="💝">💝</span>
               <span class="emoji" data-emoji="⭐">⭐</span>
               <span class="emoji" data-emoji="🌟">🌟</span>
               <span class="emoji" data-emoji="✨">✨</span>
               <span class="emoji" data-emoji="⚡">⚡</span>
               <span class="emoji" data-emoji="💥">💥</span>
               <span class="emoji" data-emoji="💫">💫</span>
               <span class="emoji" data-emoji="🔥">🔥</span>
               <span class="emoji" data-emoji="🌈">🌈</span>
               <span class="emoji" data-emoji="☀️">☀️</span>
               <span class="emoji" data-emoji="🌤️">🌤️</span>
               <span class="emoji" data-emoji="☁️">☁️</span>
               <span class="emoji" data-emoji="🌙">🌙</span>
             </div>
           </div>
         </div>
       </div>
       <input type="text" id="messageInput" placeholder="Type a message...">
       <button id="sendMessage">Send</button>
     </div>
   </div>
 </div>

 <button id="logoutButton">Logout</button>

 <div id="contextMenu">
   <ul>
     <li id="reportOption">Report</li>
     <li id="blockOption">Block</li>
   </ul>
 </div>
 
 <div id="reasonModal" class="modal">
   <div class="modal-content">
     <h3>Provide a reason</h3>
     <textarea id="reasonText" placeholder="Enter your reason here..."></textarea>
     <button id="submitReason">Submit</button>
     <button id="cancelReason">Cancel</button>
   </div>
 </div>

 <script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
 
 import { 
   getDatabase, ref, push, onChildAdded, onChildChanged, 
   get, update, query, orderByChild, set, onDisconnect, onValue} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
 import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
 
 
 const firebaseConfig = {
   apiKey: "AIzaSyDFhghmxUfCJbnnOFsleHoatF7D-ubnLpU",
   authDomain: "project-8042491080443698183.firebaseapp.com",
   databaseURL: "https://project-8042491080443698183-default-rtdb.firebaseio.com",
   projectId: "project-8042491080443698183",
   storageBucket: "project-8042491080443698183.firebasestorage.app",
   messagingSenderId: "583304911847",
   appId: "1:583304911847:web:8dfe3e5c016062dd457b42",
   measurementId: "G-KQMXKEVNQ7"
 };
 
 const app = initializeApp(firebaseConfig);
 const db = getDatabase(app);
 const auth = getAuth(app);
 
 let currentUser = null;
 let currentUsername = null;
 let selectedUser = null;
 let selectedUsername = null;
 let chatID = null;
 let chatUsers = [];
 let currentAction = null;
 let actionUser = null;
 let userCache = {}; // Cache user data to avoid repeated lookups
 let usernameResolvers = {}; // Map of email addresses to usernames
 
 // Emoji picker functionality
 const emojiButton = document.getElementById("emojiButton");
 const emojiPicker = document.getElementById("emojiPicker");
 const emojiTabs = document.querySelectorAll(".emoji-tab");
 const emojis = document.querySelectorAll(".emoji");
 const messageInput = document.getElementById("messageInput");
 
 // Toggle emoji picker
 emojiButton.addEventListener("click", function() {
   emojiPicker.style.display = emojiPicker.style.display === "none" ? "block" : "none";
 });
 
 // Tab switching
 emojiTabs.forEach(tab => {
   tab.addEventListener("click", function() {
     // Remove active class from all tabs
     emojiTabs.forEach(t => t.classList.remove("active"));
     
     // Add active class to clicked tab
     this.classList.add("active");
     
     // Hide all categories
     document.querySelectorAll(".emoji-category").forEach(category => {
       category.classList.remove("active");
     });
     
     // Show selected category
     const categoryId = this.getAttribute("data-category");
     document.getElementById(categoryId).classList.add("active");
     
     // Log for debugging
     console.log(`Showing emoji category: ${categoryId}`);
   });
 });
 
 // Initialize emoji tabs - ensure first tab is active by default
 document.querySelector(".emoji-tab[data-category='smileys']").click();
 
 // Emoji selection
 emojis.forEach(emoji => {
   emoji.addEventListener("click", function() {
     const emojiChar = this.getAttribute("data-emoji");
     
     // Insert emoji at cursor position
     const cursorPosition = messageInput.selectionStart;
     const textBefore = messageInput.value.substring(0, cursorPosition);
     const textAfter = messageInput.value.substring(cursorPosition);
     
     messageInput.value = textBefore + emojiChar + textAfter;
     
     // Set cursor position after inserted emoji
     messageInput.focus();
     messageInput.selectionStart = cursorPosition + emojiChar.length;
     messageInput.selectionEnd = cursorPosition + emojiChar.length;
     
     // Hide emoji picker after selection
     emojiPicker.style.display = "none";
   });
 });
 
 // Close emoji picker if clicked outside
 document.addEventListener("click", function(event) {
   if (!emojiPicker.contains(event.target) && event.target !== emojiButton) {
     emojiPicker.style.display = "none";
   }
 });
 
 onAuthStateChanged(auth, (user) => {
   if (user) {
     currentUser = user;
     console.log("✅ Logged in as:", currentUser.email);
     
     const usersRef = ref(db, `users/${currentUser.uid}`);
     get(usersRef).then((snapshot) => {
       if (snapshot.exists()) {
         currentUsername = snapshot.val().username;
         // Cache current user data
         userCache[currentUser.uid] = snapshot.val();
         // Cache email to username mapping
         usernameResolvers[currentUser.email] = currentUsername;
         const userStatusRef = ref(db, `users/${currentUser.uid}/status`);
         set(userStatusRef, "online");
         onDisconnect(userStatusRef).set("offline");

         // Start loading data
         preloadAllUserData().then(() => {
           loadUsers();
           setupSearch();
         });
       } else {
         console.error("❌ Current user data not found.");
       }
     });
   } else {
     window.location.href = "../LoginPage/user_login.html";
   }
 });
 
 // Preload ALL user data to fix the "Unknown User" issues
 async function preloadAllUserData() {
   console.log("🔄 Loading all user data...");
   const usersRef = ref(db, "users");
   
   try {
     const snapshot = await get(usersRef);
     if (snapshot.exists()) {
       // First build the UID to user data cache
       snapshot.forEach((childSnapshot) => {
         const userData = childSnapshot.val();
         if (userData.uid) {
           userCache[userData.uid] = userData;
           
           // Also map email to username and UID for quicker lookups
           if (userData.email && userData.username) {
             usernameResolvers[userData.email] = userData.username;
           }
         }
       });
       
       console.log(`✅ Preloaded data for ${Object.keys(userCache).length} users`);
     }
   } catch (error) {
     console.error("❌ Error preloading user data:", error);
   }
 }
 
 // Function to find username by email
 function getUsernameByEmail(email) {
   // First check our resolver cache
   if (usernameResolvers[email]) {
     return usernameResolvers[email];
   }
   
   // If not found, check all users in userCache
   for (const uid in userCache) {
     const user = userCache[uid];
     if (user.email === email) {
       // Cache this for future lookups
       usernameResolvers[email] = user.username;
       return user.username;
     }
   }
   
   return null;
 }
 
 // Function to find user by email
 function getUserByEmail(email) {
   for (const uid in userCache) {
     const user = userCache[uid];
     if (user.email === email) {
       return user;
     }
   }
   return null;
 }
 
 function loadUsers() {
   const userList = document.getElementById("userList");
   userList.innerHTML = "";

   const chatsRef = ref(db, "chats");
   const blockedRef = ref(db, `blocked/${currentUser.uid}`);

   get(blockedRef).then((blockedSnapshot) => {
     let blockedUsers = new Set();
     if (blockedSnapshot.exists()) {
       blockedSnapshot.forEach(childSnapshot => {
         blockedUsers.add(childSnapshot.key);
       });
     }

     get(chatsRef).then((snapshot) => {
       if (snapshot.exists()) {
         let chatUserIDs = new Set();

         snapshot.forEach((chatSnapshot) => {
           const [userA, userB] = chatSnapshot.key.split("_");
           if (userA === currentUser.uid && !blockedUsers.has(userB)) {
             chatUserIDs.add(userB);
           } else if (userB === currentUser.uid && !blockedUsers.has(userA)) {
             chatUserIDs.add(userA);
           }
         });

         if (chatUserIDs.size === 0) {
           userList.innerHTML = "<p>No conversations yet.</p>";
           return;
         }

         chatUsers = [];
         chatUserIDs.forEach(uid => {
           if (userCache[uid]) {
             chatUsers.push(userCache[uid]);
           }
         });

         displayUsers(chatUsers);
       } else {
         userList.innerHTML = "<p>No conversations found.</p>";
       }
     }).catch(error => {
       console.error("❌ Error loading conversations:", error);
       userList.innerHTML = "<p>Error loading conversations.</p>";
     });
   });
 }
 
 function setupSearch() {
   const searchInput = document.getElementById("searchUser");
   
   // Add a debounce function to avoid too many searches
   let searchTimeout;
   
   searchInput.addEventListener("input", () => {
     clearTimeout(searchTimeout);
     searchTimeout = setTimeout(() => {
       const searchValue = searchInput.value.trim().toLowerCase();
       
       if (searchValue === "") {
         displayUsers(chatUsers); // Show previous chats again
       } else {
         searchAllUsers(searchValue); // Search all users
       }
     }, 300); // 300ms debounce
   });
 }
 
 function searchAllUsers(searchValue) {
   const userList = document.getElementById("userList");
   
   // Search in userCache
   let filteredUsers = Object.values(userCache).filter(user => 
     user.uid !== currentUser.uid && 
     user.username && 
     user.username.toLowerCase().includes(searchValue)
   );
   
   displayUsers(filteredUsers);
 }
 
 function displayUsers(users) {
   const userList = document.getElementById("userList");
   userList.innerHTML = "";
   
   if (users.length === 0) {
     userList.innerHTML = "<p>No users found.</p>";
   } else {
     users.forEach(user => {
       let userDiv = document.createElement("div");
       userDiv.classList.add("user");
       userDiv.id = `user-${user.uid}`;
       const nameSpan = document.createElement("span");
       nameSpan.textContent = user.username;
       userDiv.appendChild(nameSpan);
       const statusSpan = document.createElement("span");
       statusSpan.classList.add("status-indicator");
       statusSpan.textContent = "⚪️ Offline";  // initial as offline
       userDiv.appendChild(statusSpan);

       userList.appendChild(userDiv);
       listenUserStatus(user.uid);

       userDiv.addEventListener("click", () => startChat(user));
       userDiv.addEventListener("contextmenu", (event) => {
         event.preventDefault();
         showContextMenu(event, user);
       });
     });
   }
 }
 
 function startChat(user) {
   selectedUser = user;
   selectedUsername = user.username;
   document.getElementById("chatUserName").innerText = `Chat with ${selectedUsername}`;
   chatID = generateChatID(currentUser.uid, selectedUser.uid);
   console.log(`📩 Chat started with ${selectedUsername} (Chat ID: ${chatID})`);
   loadMessages();
 }
 
 function generateChatID(userA, userB) {
   return userA < userB ? `${userA}_${userB}` : `${userB}_${userA}`;
 }
 
 function loadMessages() {
   const messagesDiv = document.getElementById("messages");
   messagesDiv.innerHTML = "";
   const chatRef = ref(db, `chats/${chatID}/messages`);
   
   // Keep track of messages we've already rendered
   const renderedMessageIds = new Set();
   
   // First, get all messages at once and sort them
   get(chatRef).then((snapshot) => {
     if (snapshot.exists()) {
       let messages = [];
       
       snapshot.forEach(childSnapshot => {
         const message = childSnapshot.val();
         if (!message.deleted) {
           messages.push({
             id: childSnapshot.key,
             ...message
           });
         }
         // Add to our tracking set
         renderedMessageIds.add(childSnapshot.key);
       });
       
       // Sort messages by timestamp (oldest first)
       messages.sort((a, b) => a.timestamp - b.timestamp);
       
       // Process each message in order
       const processMessages = async () => {
         for (const message of messages) {
           await renderMessage(message, message.id);
         }
         // Scroll to the bottom after all messages are rendered
         messagesDiv.scrollTop = messagesDiv.scrollHeight;
       };
       
       processMessages();
     }
   }).then(() => {
     // Only after initial load is complete, listen for new messages
     onChildAdded(chatRef, async (snapshot) => {
       const messageData = snapshot.val();
       const messageId = snapshot.key;
       
       // Skip deleted messages and messages we've already rendered
       if (messageData.deleted || renderedMessageIds.has(messageId)) {
         return;
       }
       
       // Add to our tracking set
       renderedMessageIds.add(messageId);
       
       await renderMessage(messageData, messageId);
       messagesDiv.scrollTop = messagesDiv.scrollHeight;
     });
     
     // Listen for changes to existing messages (for real-time deletion)
     onChildChanged(chatRef, (snapshot) => {
       const messageData = snapshot.val();
       const messageId = snapshot.key;
       
       // If the message is marked as deleted, hide it
       if (messageData.deleted) {
         const messageElement = document.getElementById(messageId);
         if (messageElement) {
           messageElement.style.transition = "opacity 0.5s, height 0.5s, margin 0.5s";
           messageElement.style.opacity = "0";
           messageElement.style.height = "0";
           messageElement.style.margin = "0";
           messageElement.style.overflow = "hidden";
           
           setTimeout(() => {
             messageElement.style.display = "none";
           }, 500);
           
           console.log(`🗑️ Message ${messageId} was deleted by another user.`);
         }
       }
     });
   });
 }
 
 async function resolveUsername(uid) {
   // First check cache
   if (userCache[uid] && userCache[uid].username) {
     return userCache[uid].username;
   }
   
   // If not in cache, fetch from database
   try {
     const userRef = ref(db, `users/${uid}`);
     const snapshot = await get(userRef);
     if (snapshot.exists()) {
       const userData = snapshot.val();
       // Update cache
       userCache[uid] = userData;
       listenUserStatus(uid); 
       return userData.username;
     }
   } catch (error) {
     console.error("Error fetching username:", error);
   }
   
   return "Unknown User";
 }

 function listenUserStatus(userId) {
   const userDiv = document.getElementById(`user-${userId}`);
   
   if (!userDiv) return; // Skip if user element doesn't exist
   
   if (!userDiv.querySelector('.status-indicator')) {
     const indicator = document.createElement('span');
     indicator.className = 'status-indicator';
     indicator.textContent = '⚪️ Offline';
     userDiv.appendChild(indicator);
   }

   const statusRef = ref(db, `users/${userId}/status`);

   onValue(statusRef, (snapshot) => {
     const status = snapshot.val();
     const indicator = userDiv.querySelector('.status-indicator');

     if (indicator) {
       indicator.textContent = status === "online" ? "🟢 Online" : "⚪️ Offline";
       // Add animation for status change
       indicator.style.transition = "opacity 0.3s";
       indicator.style.opacity = 0.5;
       setTimeout(() => { indicator.style.opacity = 1; }, 50);
     }
   });
 }

 async function resolveProfilePic(uid, defaultPic = "data:image/jpeg;base64,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") {
    // First check cache
    if (userCache[uid] && userCache[uid].profilePicture) {
     return userCache[uid].profilePicture;
   }
   
   // If not in cache, fetch from database
   try {
     const userRef = ref(db, `users/${uid}`);
     const snapshot = await get(userRef);
     if (snapshot.exists()) {
       const userData = snapshot.val();
       // Update cache
       userCache[uid] = userData;
       return userData.profilePicture || defaultPic;
     }
   } catch (error) {
     console.error("Error fetching profile picture:", error);
   }
   
   return defaultPic;
 }

 async function renderMessage(messageData, messageId) {
   const messagesDiv = document.getElementById("messages");

   // Create the message container
   let messageElement = document.createElement("div");
   messageElement.classList.add("message");
   messageElement.id = messageId;
   
   // Assign sent or received class
   if (messageData.sender === currentUser.email) {
     messageElement.classList.add("sent");
   } else {
     messageElement.classList.add("received");
   }
   
   // Add reply button
   let replyButton = document.createElement("button");
   replyButton.classList.add("reply-button");
   replyButton.innerText = "Reply";
   replyButton.addEventListener("click", function() {
     replyToMessage(messageData);
   });
   messageElement.appendChild(replyButton);

   // Ensure we have the sender's username and profile picture
   let senderUsername = messageData.senderUsername;
   let profilePicURL = messageData.profilePicture;
   let senderUID = messageData.senderUID;

   if (!profilePicURL && senderUID) {
     profilePicURL = await resolveProfilePic(senderUID);
   } else if (!profilePicURL) {
     profilePicURL = "data:image/jpeg;base64,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";
    }

    // Create profile picture element
   let profileImg = document.createElement("img");
   profileImg.src = profilePicURL || "data:image/jpeg;base64,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"; // Use default if missing
   profileImg.classList.add("message-profile");

    // Create sender username element
   let senderName = document.createElement("span");
   senderName.classList.add("message-username");
   senderName.innerText = senderUsername || "Unknown User";

   // Create message text element
   let textElement = document.createElement("p");
   textElement.classList.add("message-text");
   textElement.innerText = messageData.text;

   // Format timestamp
   let timeString = messageData.timestamp
     ? new Date(messageData.timestamp).toLocaleTimeString()
     : "";

   // Create timestamp element
   let timestampElement = document.createElement("div");
   timestampElement.classList.add("message-timestamp");
   timestampElement.innerText = timeString;

   // Create a wrapper for the profile picture & username
   let userWrapper = document.createElement("div");
   userWrapper.classList.add("user-wrapper");

   userWrapper.appendChild(profileImg); // Profile Picture on top
   userWrapper.appendChild(senderName); // Username below profile pic

   // Create the message content container
   let messageContent = document.createElement("div");
   messageContent.classList.add("message-content");
   messageContent.appendChild(textElement);
   messageContent.appendChild(timestampElement);

   // Create a container for the entire message
   let messageContainer = document.createElement("div");
   messageContainer.classList.add("message-container");

   messageContainer.appendChild(userWrapper); // Profile picture + username (stacked)
   messageContainer.appendChild(messageContent); // Message text below

   messageElement.appendChild(messageContainer);

   // Add delete button for sender's messages
   if (messageData.sender === currentUser.email) {
     let deleteButton = document.createElement("button");
     deleteButton.className = "delete-btn"; // Use the same class as in server
     deleteButton.innerHTML = "&times;";
     deleteButton.setAttribute("data-message-id", messageId);
     
     // Add click event to delete message
     deleteButton.addEventListener("click", (event) => {
       event.stopPropagation();
       deleteMessage(messageId);
     });
     
     messageElement.appendChild(deleteButton);
   }

   // Append message to messages container
   messagesDiv.appendChild(messageElement);
 }

 function deleteMessage(messageId) {
   if (!messageId || !chatID) {
     console.error("❌ Missing messageId or chatID for deletion");
     return;
   }

   // Reference to the specific message
   const messageRef = ref(db, `chats/${chatID}/messages/${messageId}`);
   
   // Mark the message as deleted instead of removing it completely
   // This maintains conversation context while hiding the message
   update(messageRef, {
     deleted: true
   }).then(() => {
     // Hide the message element in the UI with animation
     const messageElement = document.getElementById(messageId);
     if (messageElement) {
       messageElement.style.transition = "opacity 0.5s, height 0.5s, margin 0.5s";
       messageElement.style.opacity = "0";
       messageElement.style.height = "0";
       messageElement.style.margin = "0";
       messageElement.style.overflow = "hidden";
       
       setTimeout(() => {
         messageElement.style.display = "none";
       }, 500);
       
       console.log(`🗑️ Message ${messageId} deleted successfully.`);
     }
   }).catch(error => {
     console.error("❌ Error deleting message:", error);
     alert("Failed to delete message. Please try again.");
   });
 }

 function replyToMessage(messageData) {
   // Make sure we have the message data
   if (!messageData || !messageData.text || !messageData.senderUsername) {
     console.error("Invalid message data for reply");
     return;
   }

   const chatInput = document.getElementById("messageInput");
   if (!chatInput) {
     console.error("messageInput element not found");
     return;
   }

   // Create the quoted text with sender's name
   const replyText = `${messageData.senderUsername}: "${messageData.text}"`;
   
   // Format as quote
   const quoteText = `> ${replyText}\n\n`;
   
   // Add to beginning of input
   chatInput.value = `${quoteText}${chatInput.value}`;
   
   // Focus and place cursor at end
   chatInput.focus();
   chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length);
 }

 // Context menu functions
 function showContextMenu(event, user) {
   const contextMenu = document.getElementById("contextMenu");
   contextMenu.style.display = "block";
   contextMenu.style.left = `${event.pageX}px`;
   contextMenu.style.top = `${event.pageY}px`;

   document.getElementById("reportOption").onclick = () => reportUser(user);
   document.getElementById("blockOption").onclick = () => blockUser(user);
 }

 function reportUser(user) {
   currentAction = "report";
   actionUser = user;
   showReasonModal();
 }

 function blockUser(user) {
   currentAction = "block";
   actionUser = user;
   showReasonModal();
 }

 function showReasonModal() {
   const reasonModal = document.getElementById("reasonModal");
   const reasonText = document.getElementById("reasonText");
   reasonText.value = "";
   reasonModal.style.display = "flex";
 }

 document.getElementById("submitReason").addEventListener("click", function() {
   const reason = document.getElementById("reasonText").value.trim();
   if (!reason) {
     alert("Please provide a reason.");
     return;
   }

   if (currentAction === "block" && actionUser) {
     const blockedRef = ref(db, `blocked/${currentUser.uid}/${actionUser.uid}`);
     update(blockedRef, { blocked: true, reason: reason }).then(() => {
       alert(`🚫 You have blocked ${actionUser.username}.`);
       document.getElementById("reasonModal").style.display = "none";
       loadUsers(); // Refresh the user list
     }).catch(error => {
       console.error("❌ Error blocking user:", error);
     });
   } else if (currentAction === "report" && actionUser) {
     const reportsRef = ref(db, `reports/${actionUser.uid}`);
     push(reportsRef, {
       reportedBy: currentUser.uid,
       reason: reason,
       timestamp: Date.now()
     }).then(() => {
       alert(`🚩 You have reported ${actionUser.username}.`);
       document.getElementById("reasonModal").style.display = "none";
     }).catch(error => {
       console.error("❌ Error reporting user:", error);
     });
   }
 });

 document.getElementById("cancelReason").addEventListener("click", function() {
   document.getElementById("reasonModal").style.display = "none";
 });

 // Close context menu if clicked outside
 document.addEventListener("click", (event) => {
   const contextMenu = document.getElementById("contextMenu");
   if (contextMenu.style.display === "block" && !contextMenu.contains(event.target)) {
     contextMenu.style.display = "none";
   }
 });
 
 document.getElementById("messageInput").addEventListener("keypress", function (event) {
   if (event.key === "Enter") {
     event.preventDefault();
     document.getElementById("sendMessage").click();
   }
 });
 
 document.getElementById("sendMessage").addEventListener("click", async function() {
   if (!selectedUser) {
     alert("Select a user first!");
     return;
   }

   // Check if the selected user has blocked the current user
   const blockedBySelectedUserRef = ref(db, `blocked/${selectedUser.uid}/${currentUser.uid}`);
   const blockedSnapshot = await get(blockedBySelectedUserRef);

   if (blockedSnapshot.exists()) {
     alert(`🚫 You have been blocked by ${selectedUser.username}.`);
     return; 
   }

   const blockedByCurrentUserRef = ref(db, `blocked/${currentUser.uid}/${selectedUser.uid}`);
   const blockedByCurrentSnapshot = await get(blockedByCurrentUserRef);

   if (blockedByCurrentSnapshot.exists()) {
     alert("🚫 You have blocked this user. Unblock them to send messages.");
     return; 
   }

   // Get message text
   const messageInput = document.getElementById("messageInput");
   const messageText = messageInput.value.trim();
   if (messageText === "") return;

   // Show sending indicator
   const tempId = "temp-" + Date.now();
   const messagesDiv = document.getElementById("messages");
   const tempMessage = document.createElement("div");
   tempMessage.id = tempId;
   tempMessage.className = "message sent";
   tempMessage.innerHTML = `
     <div class="message-container">
       <div class="user-wrapper">
         <img src="data:image/jpeg;base64,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" class="message-profile">
         <span class="message-username">${currentUser.username}</span>
       </div>
       <div class="message-content">
         <p class="message-text">${messageText}</p>
         <div class="message-timestamp">Sending...</div>
       </div>
     </div>
   `;
   messagesDiv.appendChild(tempMessage);
   messagesDiv.scrollTop = messagesDiv.scrollHeight;

   // Clear input immediately for better UX
   messageInput.value = "";

   try {
     // Retrieve the current user's profile picture
     let profilePicURL = "data:image/jpeg;base64,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";

 if (userCache[currentUser.uid] && userCache[currentUser.uid].profilePicture) {
       profilePicURL = userCache[currentUser.uid].profilePicture;
     } else {
       profilePicURL = await resolveProfilePic(currentUser.uid);
     }

     // Send message to database
     const chatRef = ref(db, `chats/${chatID}/messages`);
     const newMessage = {
       sender: currentUser.email,
       senderUID: currentUser.uid,
       senderUsername: currentUsername,
       profilePicture: profilePicURL,
       text: messageText,
       timestamp: Date.now()
     };

     const newMessageRef = push(chatRef, newMessage);

     // Remove temp message (will be replaced by real-time listener)
     document.getElementById(tempId).remove();
   } catch (error) {
     console.error("Error sending message:", error);
     
     // Remove temp message and show error
     document.getElementById(tempId).remove();
     alert("Failed to send message. Please try again.");
   }
 });

 document.getElementById("logoutButton").addEventListener("click", function () {
   console.log("🚀 Logout button clicked!");
   
   signOut(auth).then(() => {
     console.log("✅ User logged out. Redirecting...");
     
     // Try the approach that works for the server interface
     window.location.replace("../../Sprint1/LoginPage/user_login.html");
     
     // Fallback options if the above doesn't work
     setTimeout(() => {
       if (window.location.href.includes("DirectMessaging")) {
         // If we're still here after a short delay, try another approach
         window.top.location.href = "../../Sprint1/LoginPage/user_login.html";
       }
     }, 200);
   }).catch(error => {
     console.error("❌ Logout failed:", error);
   });
 });
 </script>
</body>
</html>
