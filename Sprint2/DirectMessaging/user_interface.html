<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>ChatHaven - Direct Messages</title>
 <link rel="stylesheet" href="./dm.css">
 <style>
 .message .delete-button {
   cursor: pointer;
   color: red;
   font-size: 12px;
   margin-left: 10px;
 }
 #contextMenu {
   display: none;
   position: absolute;
   background-color: white;
   border: 1px solid #ccc;
   box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
   z-index: 1000;
 }
 #contextMenu ul {
   list-style: none;
   margin: 0;
   padding: 0;
 }
 #contextMenu li {
   padding: 8px 12px;
   cursor: pointer;
 }
 #contextMenu li:hover {
   background-color: #f1f1f1;
 }
 .modal {
   display: none;
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background-color: rgba(0, 0, 0, 0.5);
   justify-content: center;
   align-items: center;
   z-index: 1001;
 }
 .modal-content {
   background-color: #2e3136;
   padding: 20px;
   border-radius: 5px;
   width: 300px;
 }
 .modal-content textarea {
   width: 100%;
   height: 100px;
   margin-bottom: 10px;
 }
 #logoutButton {
   position: fixed;
   bottom: 20px;
   left: 20px;
   padding: 10px 20px;
   background-color: red;
   color: white;
   border: none;
   cursor: pointer;
   font-size: 16px;
   border-radius: 5px;
 }
 #logoutButton:hover {
   background-color: darkred;
 }
 
 /* Emoji Picker Styles */
 .emoji-container {
   position: relative;
   margin-right: 10px;
 }
 
 #emojiButton {
   cursor: pointer;
   background: none;
   border: none;
   font-size: 20px;
   padding: 10px;
   border-radius: 5px;
   transition: background 0.3s;
 }
 
 #emojiButton:hover {
   background-color: #2e3136;
 }
 
 #emojiPicker {
   position: absolute;
   bottom: 50px;
   left: 0;
   width: 300px;
   background: #2e3136;
   border: 1px solid #2e3136;
   border-radius: 5px;
   box-shadow: 0 5px 15px rgba(0,0,0,0.2);
   z-index: 1000;
 }
 
 .emoji-tabs {
   display: flex;
   border-bottom: 1px solid #2e3136;
 }
 
 .emoji-tab {
   flex: 1;
   padding: 10px;
   text-align: center;
   background: none;
   border: none;
   cursor: pointer;
 }
 
 .emoji-tab.active {
   background-color: blue;
 }
 
 .emoji-content {
   max-height: 200px;
   overflow-y: auto;
   padding: 10px;
 }
 
 .emoji-category {
   display: none;
   flex-wrap: wrap;
   gap: 5px;
 }
 
 .emoji-category.active {
   display: flex;
 }
 
 .emoji {
   font-size: 20px;
   cursor: pointer;
   padding: 5px;
   border-radius: 5px;
 }
 
 .emoji:hover {
   background-color: #f1f1f1;
 }

 /* Message styles */
 .message .reply-button {
   background-color: #e1e1e1;
   border: none;
   border-radius: 3px;
   padding: 3px 8px;
   font-size: 12px;
   margin-right: 5px;
   cursor: pointer;
   display: none;
 }

 .message:hover .reply-button {
   display: inline-block;
 }

 .message .delete-btn {
   position: absolute;
   right: 10px;
   top: 10px;
   background: none;
   border: none;
   color: #ff5555;
   font-size: 18px;
   cursor: pointer;
   opacity: 0;
   transition: opacity 0.2s;
 }

 .message:hover .delete-btn {
   opacity: 1;
 }

 .status-indicator {
   margin-left: 8px;
   font-size: 12px;
   transition: opacity 0.3s;
 }

 .user-wrapper {
   display: flex;
   flex-direction: column;
   align-items: center;
   margin-right: 15px;
 }

 .message-container {
   display: flex;
   margin-bottom: 8px;
   position: relative;
 }

 .message-content {
   flex: 1;
 }

 .message-text {
   margin: 0 0 5px 0;
   word-break: break-word;
 }

 .message-timestamp {
   font-size: 12px;
   color: #888;
   text-align: right;
 }

 .message-profile {
   width: 40px;
   height: 40px;
   border-radius: 50%;
   object-fit: cover;
   margin-bottom: 4px;
 }

 .message-username {
   font-size: 12px;
   max-width: 60px;
   white-space: nowrap;
   overflow: hidden;
   text-overflow: ellipsis;
   text-align: center;
 }
 </style>
</head>
<body>
 <div class="chat-container">
   <div class="sidebar">
     <h2>Direct Messages</h2>
     <input type="text" id="searchUser" placeholder="Search for a user...">
     <div id="userList"></div>
   </div>

   <div class="chat-box">
     <h2 id="chatUserName">Select a user to chat</h2>
     <div id="messages"></div>
     <div class="message-input">
       <div class="emoji-container">
         <button id="emojiButton">ğŸ˜Š</button>
         <div id="emojiPicker" style="display: none;">
           <div class="emoji-tabs">
             <button class="emoji-tab active" data-category="smileys">ğŸ˜€</button>
             <button class="emoji-tab" data-category="animals">ğŸ±</button>
             <button class="emoji-tab" data-category="food">ğŸ”</button>
             <button class="emoji-tab" data-category="symbols">â¤ï¸</button>
           </div>
           <div class="emoji-content">
             <div class="emoji-category active" id="smileys">
               <span class="emoji" data-emoji="ğŸ˜€">ğŸ˜€</span>
               <span class="emoji" data-emoji="ğŸ˜ƒ">ğŸ˜ƒ</span>
               <span class="emoji" data-emoji="ğŸ˜„">ğŸ˜„</span>
               <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
               <span class="emoji" data-emoji="ğŸ˜†">ğŸ˜†</span>
               <span class="emoji" data-emoji="ğŸ˜…">ğŸ˜…</span>
               <span class="emoji" data-emoji="ğŸ¤£">ğŸ¤£</span>
               <span class="emoji" data-emoji="ğŸ˜‚">ğŸ˜‚</span>
               <span class="emoji" data-emoji="ğŸ™‚">ğŸ™‚</span>
               <span class="emoji" data-emoji="ğŸ™ƒ">ğŸ™ƒ</span>
               <span class="emoji" data-emoji="ğŸ˜‰">ğŸ˜‰</span>
               <span class="emoji" data-emoji="ğŸ˜Š">ğŸ˜Š</span>
               <span class="emoji" data-emoji="ğŸ˜‡">ğŸ˜‡</span>
               <span class="emoji" data-emoji="ğŸ¥°">ğŸ¥°</span>
               <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
               <span class="emoji" data-emoji="ğŸ¤©">ğŸ¤©</span>
               <span class="emoji" data-emoji="ğŸ˜˜">ğŸ˜˜</span>
               <span class="emoji" data-emoji="ğŸ˜—">ğŸ˜—</span>
               <span class="emoji" data-emoji="ğŸ˜š">ğŸ˜š</span>
               <span class="emoji" data-emoji="ğŸ˜™">ğŸ˜™</span>
               <span class="emoji" data-emoji="ğŸ¥²">ğŸ¥²</span>
               <span class="emoji" data-emoji="ğŸ˜‹">ğŸ˜‹</span>
               <span class="emoji" data-emoji="ğŸ˜›">ğŸ˜›</span>
               <span class="emoji" data-emoji="ğŸ˜œ">ğŸ˜œ</span>
               <span class="emoji" data-emoji="ğŸ¤ª">ğŸ¤ª</span>
               <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
               <span class="emoji" data-emoji="ğŸ¤‘">ğŸ¤‘</span>
               <span class="emoji" data-emoji="ğŸ¤—">ğŸ¤—</span>
               <span class="emoji" data-emoji="ğŸ¤­">ğŸ¤­</span>
               <span class="emoji" data-emoji="ğŸ¤«">ğŸ¤«</span>
               <span class="emoji" data-emoji="ğŸ¤”">ğŸ¤”</span>
               <span class="emoji" data-emoji="ğŸ¤¤">ğŸ¤¤</span>
               <span class="emoji" data-emoji="ğŸ¤">ğŸ¤</span>
               <span class="emoji" data-emoji="ğŸ¥´">ğŸ¥´</span>
               <span class="emoji" data-emoji="ğŸ˜´">ğŸ˜´</span>
               <span class="emoji" data-emoji="ğŸ¥±">ğŸ¥±</span>
               <span class="emoji" data-emoji="ğŸ˜·">ğŸ˜·</span>
               <span class="emoji" data-emoji="ğŸ–•">ğŸ–•</span>
               <span class="emoji" data-emoji="ğŸ’€">ğŸ’€</span>
               <span class="emoji" data-emoji="ğŸ’©">ğŸ’©</span>
               <span class="emoji" data-emoji="ğŸ¤¢">ğŸ¤¢</span>
             </div>
             <div class="emoji-category" id="animals">
               <span class="emoji" data-emoji="ğŸ¶">ğŸ¶</span>
               <span class="emoji" data-emoji="ğŸ±">ğŸ±</span>
               <span class="emoji" data-emoji="ğŸ­">ğŸ­</span>
               <span class="emoji" data-emoji="ğŸ¹">ğŸ¹</span>
               <span class="emoji" data-emoji="ğŸ°">ğŸ°</span>
               <span class="emoji" data-emoji="ğŸ¦Š">ğŸ¦Š</span>
               <span class="emoji" data-emoji="ğŸ»">ğŸ»</span>
               <span class="emoji" data-emoji="ğŸ¼">ğŸ¼</span>
               <span class="emoji" data-emoji="ğŸ¨">ğŸ¨</span>
               <span class="emoji" data-emoji="ğŸ¯">ğŸ¯</span>
               <span class="emoji" data-emoji="ğŸ¦">ğŸ¦</span>
               <span class="emoji" data-emoji="ğŸ®">ğŸ®</span>
               <span class="emoji" data-emoji="ğŸ·">ğŸ·</span>
               <span class="emoji" data-emoji="ğŸ¸">ğŸ¸</span>
               <span class="emoji" data-emoji="ğŸµ">ğŸµ</span>
               <span class="emoji" data-emoji="ğŸ”">ğŸ”</span>
               <span class="emoji" data-emoji="ğŸ§">ğŸ§</span>
               <span class="emoji" data-emoji="ğŸ¦">ğŸ¦</span>
               <span class="emoji" data-emoji="ğŸ¦„">ğŸ¦„</span>
               <span class="emoji" data-emoji="ğŸ¦‡">ğŸ¦‡</span>
               <span class="emoji" data-emoji="ğŸ¦‰">ğŸ¦‰</span>
               <span class="emoji" data-emoji="ğŸ¦‹">ğŸ¦‹</span>
               <span class="emoji" data-emoji="ğŸ">ğŸ</span>
               <span class="emoji" data-emoji="ğŸ¢">ğŸ¢</span>
               <span class="emoji" data-emoji="ğŸ™">ğŸ™</span>
               <span class="emoji" data-emoji="ğŸ¦‘">ğŸ¦‘</span>
               <span class="emoji" data-emoji="ğŸ¦">ğŸ¦</span>
               <span class="emoji" data-emoji="ğŸ¦€">ğŸ¦€</span>
               <span class="emoji" data-emoji="ğŸ¬">ğŸ¬</span>
               <span class="emoji" data-emoji="ğŸ³">ğŸ³</span>
             </div>
             <div class="emoji-category" id="food">
               <span class="emoji" data-emoji="ğŸ">ğŸ</span>
               <span class="emoji" data-emoji="ğŸ">ğŸ</span>
               <span class="emoji" data-emoji="ğŸŠ">ğŸŠ</span>
               <span class="emoji" data-emoji="ğŸ‹">ğŸ‹</span>
               <span class="emoji" data-emoji="ğŸŒ">ğŸŒ</span>
               <span class="emoji" data-emoji="ğŸ‰">ğŸ‰</span>
               <span class="emoji" data-emoji="ğŸ‡">ğŸ‡</span>
               <span class="emoji" data-emoji="ğŸ“">ğŸ“</span>
               <span class="emoji" data-emoji="ğŸˆ">ğŸˆ</span>
               <span class="emoji" data-emoji="ğŸ’">ğŸ’</span>
               <span class="emoji" data-emoji="ğŸ‘">ğŸ‘</span>
               <span class="emoji" data-emoji="ğŸ¥­">ğŸ¥­</span>
               <span class="emoji" data-emoji="ğŸ">ğŸ</span>
               <span class="emoji" data-emoji="ğŸ¥¥">ğŸ¥¥</span>
               <span class="emoji" data-emoji="ğŸ¥">ğŸ¥</span>
               <span class="emoji" data-emoji="ğŸ…">ğŸ…</span>
               <span class="emoji" data-emoji="ğŸ†">ğŸ†</span>
               <span class="emoji" data-emoji="ğŸ¥‘">ğŸ¥‘</span>
               <span class="emoji" data-emoji="ğŸ¥¦">ğŸ¥¦</span>
               <span class="emoji" data-emoji="ğŸ¥¬">ğŸ¥¬</span>
               <span class="emoji" data-emoji="ğŸ¥•">ğŸ¥•</span>
               <span class="emoji" data-emoji="ğŸŒ½">ğŸŒ½</span>
               <span class="emoji" data-emoji="ğŸŒ¶ï¸">ğŸŒ¶ï¸</span>
               <span class="emoji" data-emoji="ğŸ¥">ğŸ¥</span>
               <span class="emoji" data-emoji="ğŸ">ğŸ</span>
               <span class="emoji" data-emoji="ğŸ¥¨">ğŸ¥¨</span>
               <span class="emoji" data-emoji="ğŸ”">ğŸ”</span>
               <span class="emoji" data-emoji="ğŸŸ">ğŸŸ</span>
               <span class="emoji" data-emoji="ğŸ•">ğŸ•</span>
               <span class="emoji" data-emoji="ğŸŒ­">ğŸŒ­</span>
               <span class="emoji" data-emoji="ğŸ¿">ğŸ¿</span>
               <span class="emoji" data-emoji="ğŸ§">ğŸ§</span>
               <span class="emoji" data-emoji="ğŸ°">ğŸ°</span>
               <span class="emoji" data-emoji="ğŸ«">ğŸ«</span>
               <span class="emoji" data-emoji="ğŸ¬">ğŸ¬</span>
             </div>
             <div class="emoji-category" id="symbols">
               <span class="emoji" data-emoji="â¤ï¸">â¤ï¸</span>
               <span class="emoji" data-emoji="ğŸ§¡">ğŸ§¡</span>
               <span class="emoji" data-emoji="ğŸ’›">ğŸ’›</span>
               <span class="emoji" data-emoji="ğŸ’š">ğŸ’š</span>
               <span class="emoji" data-emoji="ğŸ’™">ğŸ’™</span>
               <span class="emoji" data-emoji="ğŸ’œ">ğŸ’œ</span>
               <span class="emoji" data-emoji="ğŸ–¤">ğŸ–¤</span>
               <span class="emoji" data-emoji="ğŸ¤">ğŸ¤</span>
               <span class="emoji" data-emoji="ğŸ¤">ğŸ¤</span>
               <span class="emoji" data-emoji="ğŸ’”">ğŸ’”</span>
               <span class="emoji" data-emoji="â£ï¸">â£ï¸</span>
               <span class="emoji" data-emoji="ğŸ’•">ğŸ’•</span>
               <span class="emoji" data-emoji="ğŸ’">ğŸ’</span>
               <span class="emoji" data-emoji="ğŸ’“">ğŸ’“</span>
               <span class="emoji" data-emoji="ğŸ’—">ğŸ’—</span>
               <span class="emoji" data-emoji="ğŸ’–">ğŸ’–</span>
               <span class="emoji" data-emoji="ğŸ’˜">ğŸ’˜</span>
               <span class="emoji" data-emoji="ğŸ’">ğŸ’</span>
               <span class="emoji" data-emoji="â­">â­</span>
               <span class="emoji" data-emoji="ğŸŒŸ">ğŸŒŸ</span>
               <span class="emoji" data-emoji="âœ¨">âœ¨</span>
               <span class="emoji" data-emoji="âš¡">âš¡</span>
               <span class="emoji" data-emoji="ğŸ’¥">ğŸ’¥</span>
               <span class="emoji" data-emoji="ğŸ’«">ğŸ’«</span>
               <span class="emoji" data-emoji="ğŸ”¥">ğŸ”¥</span>
               <span class="emoji" data-emoji="ğŸŒˆ">ğŸŒˆ</span>
               <span class="emoji" data-emoji="â˜€ï¸">â˜€ï¸</span>
               <span class="emoji" data-emoji="ğŸŒ¤ï¸">ğŸŒ¤ï¸</span>
               <span class="emoji" data-emoji="â˜ï¸">â˜ï¸</span>
               <span class="emoji" data-emoji="ğŸŒ™">ğŸŒ™</span>
             </div>
           </div>
         </div>
       </div>
       <input type="text" id="messageInput" placeholder="Type a message...">
       <button id="sendMessage">Send</button>
     </div>
   </div>
 </div>

 <button id="logoutButton">Logout</button>

 <div id="contextMenu">
   <ul>
     <li id="reportOption" style = color:black>Report</li>
     <li id="blockOption" style = color:black>Block</li>
   </ul>
 </div>
 
 <div id="reasonModal" class="modal">
   <div class="modal-content">
     <h3>Provide a reason</h3>
     <textarea id="reasonText" placeholder="Enter your reason here..."></textarea>
     <button id="submitReason">Submit</button>
     <button id="cancelReason">Cancel</button>
   </div>
 </div>

 <script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
 
 import {
   getDatabase, ref, push, onChildAdded, onChildChanged,
   get, update, query, orderByChild, set, onDisconnect, onValue} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
 import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
 
// ===== IMPROVED STEVE AI CHATBOT CONFIGURATION =====
const STEVE = {
  uid: "steve-ai-chatbot-uid",
  username: "Steve AI",
  email: "steve-ai@chathaven.com",
  status: "online",
  profilePicture: "https://cdn.pixabay.com/photo/2016/11/18/23/38/child-1837375_1280.png", // Default robot/AI image
  bio: "I'm Steve, your friendly AI assistant. Ask me anything!",
  isBot: true
};

// Function to add Steve to the database if he doesn't exist
function initializeSteve(db) {
  console.log("Initializing Steve AI...");
  const steveRef = ref(db, `users/${STEVE.uid}`);
 
  // Check if Steve already exists in the database
  get(steveRef).then((snapshot) => {
    if (!snapshot.exists()) {
      // Add Steve to the database
      set(steveRef, {
        uid: STEVE.uid,
        username: STEVE.username,
        email: STEVE.email,
        status: "online",
        profilePicture: STEVE.profilePicture,
        bio: STEVE.bio,
        isBot: true,
        createdAt: Date.now()
      }).then(() => {
        console.log("âœ… Steve AI has been added to the database");
      }).catch(error => {
        console.error("âŒ Error adding Steve AI to the database:", error);
      });
    } else {
      console.log("âœ… Steve AI already exists in the database");
      // Update Steve's status to online
      const statusRef = ref(db, `users/${STEVE.uid}/status`);
      set(statusRef, "online");
    }
  }).catch(error => {
    console.error("âŒ Error checking if Steve exists:", error);
  });
}

// Load and store user context for personalized conversations
class UserContextManager {
  constructor() {
    this.userContexts = {};
  }
 
  // Get or create user context
  getContext(userId) {
    if (!this.userContexts[userId]) {
      this.userContexts[userId] = {
        name: null,
        recentTopics: [],
        preferences: {},
        lastInteraction: Date.now(),
        conversationHistory: [], // Store last 10 interactions
        mood: "neutral"
      };
    }
    return this.userContexts[userId];
  }
 
  // Update user context with new information
  updateContext(userId, updates) {
    const context = this.getContext(userId);
    Object.assign(context, updates);
    context.lastInteraction = Date.now();
    return context;
  }
 
  // Add message to context history
  addToHistory(userId, message, isUser = true) {
    const context = this.getContext(userId);
    context.conversationHistory.push({
      text: message,
      timestamp: Date.now(),
      isUser
    });
   
    // Keep only the last 10 messages
    if (context.conversationHistory.length > 10) {
      context.conversationHistory.shift();
    }
  }
 
  // Get topics from conversation
  extractTopics(message) {
    const topics = [];
    // Simple keyword extraction
    const keywords = [
      'weather', 'time', 'joke', 'math', 'calculate',
      'help', 'chat', 'greeting', 'music', 'movie',
      'food', 'travel', 'news', 'sports', 'technology'
    ];
   
    const lowercaseMsg = message.toLowerCase();
    for (const keyword of keywords) {
      if (lowercaseMsg.includes(keyword)) {
        topics.push(keyword);
      }
    }
   
    return topics;
  }
}

// Initialize the context manager
const userContextManager = new UserContextManager();

// Function to prevent multiple message sending - using debounce
function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

// Natural Language Understanding module
class NLUModule {
  constructor() {
    // Intent patterns
    this.intents = {
      greeting: [
        /\b(hi|hello|hey|howdy|greetings|good morning|good afternoon|good evening)\b/i
      ],
      farewell: [
        /\b(bye|goodbye|see you|farewell|later|good night)\b/i
      ],
      thankYou: [
        /\b(thanks|thank you|appreciate|grateful)\b/i
      ],
      help: [
        /\b(help|assist|support|guide|how do|how can|what can you do)\b/i
      ],
      weather: [
        /\b(weather|forecast|temperature|rain|sunny|cloudy)\b/i
      ],
      time: [
        /\b(time|date|day|hour|minute|clock|today is)\b/i
      ],
      joke: [
        /\b(joke|funny|humor|laugh|amuse|entertain)\b/i
      ],
      math: [
        /\b(calculate|compute|solve|math|equation|problem|plus|minus|times|divided by|equals|sum|difference|product|quotient)\b/i,
        /[0-9\+\-\*\/\(\)\^\%]+/
      ],
      about: [
        /\b(who are you|what are you|about you|your name|tell me about you|steve)\b/i
      ],
      feeling: [
        /\b(how are you|feeling|how do you feel|how's it going|are you ok|are you good)\b/i
      ],
      facts: [
        /\b(tell me|fact|interesting|did you know|trivia)\b/i
      ],
      question: [
        /\b(what|who|where|when|why|how|is it|are they|can you|could you|would you)\b/i
      ]
    };
   
    // Entity patterns
    this.entities = {
      number: /\b\d+(\.\d+)?\b/g,
      date: /\b(today|tomorrow|yesterday|next week|last week|this month)\b/i,
      name: /\bmy name is ([A-Za-z]+)\b/i,
    };
  }
 
  // Detect intent from user message
  detectIntent(message) {
    const results = [];
    const lowercaseMsg = message.toLowerCase();
   
    // Check for math expressions first to handle special case
    if (this.isMathProblem(lowercaseMsg)) {
      return [{intent: 'math', confidence: 0.95}];
    }
   
    // Check other intents
    for (const [intent, patterns] of Object.entries(this.intents)) {
      for (const pattern of patterns) {
        if (pattern.test(lowercaseMsg)) {
          results.push({
            intent,
            confidence: 0.8  // Simplified confidence score
          });
          break; // Move to next intent after first match
        }
      }
    }
   
    // If no intent matched, default to general conversation
    if (results.length === 0) {
      results.push({
        intent: 'conversation',
        confidence: 0.6
      });
    }
   
    // Sort by confidence (highest first)
    return results.sort((a, b) => b.confidence - a.confidence);
  }
 
  // Extract entities from message
  extractEntities(message) {
    const entities = {};
   
    // Extract numbers
    const numbers = message.match(this.entities.number);
    if (numbers) {
      entities.numbers = numbers.map(n => parseFloat(n));
    }
   
    // Extract dates
    const dateMatch = message.match(this.entities.date);
    if (dateMatch) {
      entities.date = dateMatch[0];
    }
   
    // Extract name
    const nameMatch = message.match(this.entities.name);
    if (nameMatch && nameMatch[1]) {
      entities.name = nameMatch[1];
    }
   
    return entities;
  }
 
  // Detect if message is a math problem
  isMathProblem(message) {
    // Check for numbers and operators
    const hasNumbers = /\d+/.test(message);
    const hasOperators = /[\+\-\*\/\^\%]/.test(message);
   
    // Check for math keywords
    const hasMathKeywords = /(calculate|compute|solve|what is|equals|plus|minus|times|divided by)/.test(message);
   
    return (hasNumbers && hasOperators) || (hasNumbers && hasMathKeywords);
  }
}

// Response generator module
class ResponseGenerator {
  constructor() {
    this.nlu = new NLUModule();
   
    // Database of facts
    this.facts = [
      "The shortest war in history was between Britain and Zanzibar in 1896. It lasted only 38 minutes.",
      "A day on Venus is longer than a year on Venus. It takes 243 Earth days to rotate once on its axis.",
      "The Hawaiian alphabet has only 12 letters.",
      "An octopus has three hearts, nine brains, and blue blood.",
      "Honey never spoils. Archaeologists have found pots of honey in ancient Egyptian tombs that are over 3,000 years old and still perfectly good to eat.",
      "A group of flamingos is called a 'flamboyance'.",
      "The fingerprints of koalas are so similar to humans that they have confused crime scene investigators.",
      "The Great Wall of China is not visible from space with the naked eye, contrary to popular belief.",
      "Bananas are berries, but strawberries aren't.",
      "A blue whale's heart is so big that a human could swim through its arteries.",
      "The only letter that doesn't appear in the periodic table is J.",
      "Cows have best friends and get stressed when they are separated.",
      "The world's oldest known living tree is over 5,000 years old.",
      "A day on Mars is about 24 hours and 37 minutes long.",
      "There are more possible iterations of a game of chess than there are atoms in the known universe."
    ];
   
    // Database of jokes
    this.jokes = [
      "Why don't scientists trust atoms? Because they make up everything!",
      "Did you hear about the mathematician who's afraid of negative numbers? He'll stop at nothing to avoid them!",
      "Why was the math book sad? It had too many problems.",
      "What's the best thing about Switzerland? I don't know, but the flag is a big plus!",
      "I told my wife she was drawing her eyebrows too high. She looked surprised.",
      "Why did the scarecrow win an award? Because he was outstanding in his field!",
      "How does a penguin build its house? Igloos it together!",
      "What do you call a fake noodle? An impasta!",
      "Why don't eggs tell jokes? They'd crack each other up!",
      "How do you organize a space party? You planet!",
      "I'm reading a book about anti-gravity. It's impossible to put down!",
      "What did the ocean say to the beach? Nothing, it just waved.",
      "Why was the belt sent to jail? It held up a pair of pants!",
      "I would tell you a chemistry joke, but I know I wouldn't get a reaction.",
      "What do you call a parade of rabbits hopping backwards? A receding hare-line."
    ];
   
    // Conversation responses for different scenarios
    this.conversations = {
      greetings: [
        "Hello! How can I help you today?",
        "Hi there! Nice to chat with you!",
        "Hey! What can I do for you?",
        "Greetings! How's your day going?",
        "Hello! I'm Steve, your AI assistant. What's on your mind?"
      ],
      farewells: [
        "Goodbye! Feel free to chat again anytime!",
        "See you later! Have a great day!",
        "Bye for now! Come back soon!",
        "Take care! I'll be here if you need anything.",
        "Until next time! It was nice chatting with you!"
      ],
      thanks: [
        "You're welcome! Happy to help!",
        "Anytime! Let me know if you need anything else.",
        "My pleasure! Is there anything else you'd like to know?",
        "Glad I could assist! Don't hesitate to ask if you have more questions.",
        "You're very welcome! I'm here whenever you need help."
      ],
      about: [
        "I'm Steve, an AI assistant integrated into ChatHaven. I can answer questions, help with calculations, tell jokes, share facts, and just chat!",
        "I'm your virtual assistant, Steve. I'm designed to be helpful, informative, and occasionally entertaining!",
        "Hello! I'm Steve AI, your digital companion. I'm here to assist with information, calculations, or just to have a friendly conversation.",
        "I'm Steve, a chatbot created to assist ChatHaven users. I don't have feelings, but I'm programmed to be friendly and helpful!",
        "I'm Steve! Think of me as your personal AI assistant. I can help with a variety of tasks and information requests."
      ],
      feelings: [
        "I'm doing well, thanks for asking! How about you?",
        "I'm functioning perfectly! How's your day going?",
        "All systems operational and ready to assist! How are you today?",
        "I'm good! As an AI, I don't have feelings, but I appreciate you asking. How can I help you?",
        "I'm great! Always happy to chat. How are you feeling today?"
      ],
      help: [
        "I can help with various things! I can answer questions, do math calculations, tell jokes, share interesting facts, provide the time, or just chat. What would you like help with?",
        "I'm here to assist! I can solve math problems, tell jokes, share facts, chat about various topics, or just keep you company. What do you need?",
        "Need help? I can perform calculations, provide information, tell jokes, or just have a conversation. Let me know what you're looking for!",
        "I'm your AI assistant! I can help with calculations, share interesting facts, tell jokes, or just chat. What would you like me to do?",
        "I'm here to help! Whether you need information, entertainment, or just someone to talk to, I've got you covered. What can I do for you today?"
      ],
      weather: [
        "I don't have access to real-time weather data, but I'd be happy to chat about other topics!",
        "Unfortunately, I can't check the weather for you right now. Is there something else I can help with?",
        "I wish I could tell you about the weather, but I don't have that capability. Can I assist with something else?",
        "I don't have access to weather information, but I'm here for other questions you might have!",
        "As an AI in this chat application, I can't access current weather data. But I'm happy to help with other topics!"
      ],
      fallback: [
        "That's an interesting point. Tell me more about it.",
        "I'm not sure I fully understand. Could you tell me more?",
        "That's something to think about. What else is on your mind?",
        "Interesting perspective! Would you like to discuss this further?",
        "I appreciate you sharing that. Is there anything specific you'd like to know or discuss?",
        "I'm still learning, but that sounds interesting. Can you elaborate?",
        "Thanks for sharing. How can I help you with this topic?",
        "I'm here to chat about whatever interests you. Would you like to explore this topic further?"
      ]
    };
  }
 
  // Generate response based on user message and context
  async generateResponse(message, userId) {
    // Update user context
    userContextManager.addToHistory(userId, message);
    const userContext = userContextManager.getContext(userId);
   
    // Extract topics from message
    const topics = userContextManager.extractTopics(message);
    if (topics.length > 0) {
      userContext.recentTopics = [...topics, ...userContext.recentTopics].slice(0, 5);
    }
   
    // Analyze the message
    const intents = this.nlu.detectIntent(message);
    const entities = this.nlu.extractEntities(message);
    const primaryIntent = intents[0].intent;
   
    // Extract name if present and update context
    if (entities.name && !userContext.name) {
      userContext.name = entities.name;
      userContextManager.updateContext(userId, {name: entities.name});
      return `Nice to meet you, ${entities.name}! How can I help you today?`;
    }
   
    // Generate response based on intent
    let response;
   
    switch (primaryIntent) {
      case 'greeting':
        response = this.getRandomResponse(this.conversations.greetings);
        if (userContext.name) {
          response = response.replace('!', `, ${userContext.name}!`);
        }
        break;
       
      case 'farewell':
        response = this.getRandomResponse(this.conversations.farewells);
        if (userContext.name) {
          response = response.replace('!', `, ${userContext.name}!`);
        }
        break;
       
      case 'thankYou':
        response = this.getRandomResponse(this.conversations.thanks);
        break;
       
      case 'help':
        response = this.getRandomResponse(this.conversations.help);
        break;
       
      case 'weather':
        response = this.getRandomResponse(this.conversations.weather);
        break;
       
      case 'time':
        const now = new Date();
        response = `The current time is ${now.toLocaleTimeString()}, and today is ${now.toLocaleDateString()}.`;
        break;
       
      case 'joke':
        response = this.getRandomResponse(this.jokes);
        break;
       
      case 'math':
        try {
          response = this.solveCalculation(message);
        } catch (error) {
          response = "I couldn't solve that calculation. Could you rephrase it?";
        }
        break;
       
      case 'about':
        response = this.getRandomResponse(this.conversations.about);
        break;
       
      case 'feeling':
        response = this.getRandomResponse(this.conversations.feelings);
        break;
       
      case 'facts':
        response = this.getRandomResponse(this.facts);
        break;
       
      case 'question':
        // For questions we don't have specific answers to
        if (message.toLowerCase().includes('your name')) {
          response = "My name is Steve! I'm an AI assistant here to help you.";
        } else if (message.toLowerCase().includes('how old')) {
          response = "I'm a relatively new AI, so I don't really have an age in the human sense!";
        } else {
          response = "That's an interesting question! I'm designed for casual conversation, so I might not have all the answers. Is there something else I can help with?";
        }
        break;
       
      default:
        // Handle general conversation
        if (userContext.conversationHistory.length > 1) {
          // Try to make response contextual based on history
          const lastUserMessage = userContext.conversationHistory[userContext.conversationHistory.length - 2];
          if (lastUserMessage && lastUserMessage.text.toLowerCase().includes('you')) {
            response = "I appreciate your engagement! What else would you like to chat about?";
          } else {
            response = this.getRandomResponse(this.conversations.fallback);
          }
        } else {
          response = this.getRandomResponse(this.conversations.fallback);
        }
    }
   
    // Add response to user context
    userContextManager.addToHistory(userId, response, false);
   
    return response;
  }
 
  // Helper function to get random response
  getRandomResponse(responseArray) {
    return responseArray[Math.floor(Math.random() * responseArray.length)];
  }
 
  // Helper function to solve calculations
  solveCalculation(message) {
    // Extract the calculation part
    let expression = message;
   
    // Replace math words with symbols
    expression = expression.replace(/plus/gi, '+');
    expression = expression.replace(/minus/gi, '-');
    expression = expression.replace(/times/gi, '*');
    expression = expression.replace(/multiplied by/gi, '*');
    expression = expression.replace(/divided by/gi, '/');
    expression = expression.replace(/Ã—/g, '*');
    expression = expression.replace(/Ã·/g, '/');
   
    // Extract numbers and math operators
    const extractedMath = expression.match(/[0-9+\-*/()\s.^%]+/g);
    if (extractedMath) {
      expression = extractedMath.join('');
    }
   
    // Clean up the expression
    expression = expression.replace(/[^0-9+\-*/()\s.^%]/g, '');
   
    try {
      // Safely evaluate the expression using Function instead of eval
      const result = new Function('return ' + expression)();
     
      // Format response
      if (Number.isInteger(result)) {
        return `The result is ${result}`;
      } else {
        return `The result is ${parseFloat(result.toFixed(4))}`;
      }
    } catch (error) {
      console.error("Calculation error:", error);
      return "I'm having trouble solving that calculation. Could you rephrase it?";
    }
  }
}

// Main function to handle messaging Steve with debouncing to prevent duplicate messages
const sendMessageToSteve = debounce(async (db, currentUser, messageText) => {
  console.log("Sending message to Steve:", messageText);
 
  // Make sure we have all required data for the message
  if (!currentUser || !currentUser.uid) {
    console.error("âŒ Current user data is missing!");
    return;
  }
 
  // Make sure we have a username - use email as fallback
  const senderUsername = currentUser.username || currentUser.email.split('@')[0] || "User";
 
  // Generate chat ID exactly the same way as your app does
  const chatID = currentUser.uid < STEVE.uid
    ? `${currentUser.uid}_${STEVE.uid}`
    : `${STEVE.uid}_${currentUser.uid}`;
   
  console.log("Chat ID for Steve:", chatID);
  const chatRef = ref(db, `chats/${chatID}/messages`);
 
  // Initialize the response generator if needed
  const responseGenerator = new ResponseGenerator();
 
  // Add user message to database
  push(chatRef, {
    sender: currentUser.email,
    senderUID: currentUser.uid,
    senderUsername: senderUsername,
    profilePicture: currentUser.profilePicture || "",
    text: messageText,
    timestamp: Date.now(),
    isProcessed: true // Flag to prevent duplicate processing
  }).then(async (messageRef) => {
    console.log("âœ… Message sent to Steve AI with messageId:", messageRef.key);
   
    // Show typing indicator
    push(chatRef, {
      sender: STEVE.email,
      senderUID: STEVE.uid,
      senderUsername: STEVE.username,
      profilePicture: STEVE.profilePicture,
      text: "...",
      timestamp: Date.now(),
      isTyping: true,
      isProcessed: true
    }).then((typingRef) => {
      // Generate Steve's response with a small delay to simulate thinking
      setTimeout(async () => {
        // Generate response
        const steveResponse = await responseGenerator.generateResponse(messageText, currentUser.uid);
       
        // Remove typing indicator (using set(null) instead of remove())
        const typingMsgRef = ref(db, `chats/${chatID}/messages/${typingRef.key}`);
        set(typingMsgRef, null).then(() => {
          // Add Steve's response to database
          push(chatRef, {
            sender: STEVE.email,
            senderUID: STEVE.uid,
            senderUsername: STEVE.username,
            profilePicture: STEVE.profilePicture,
            text: steveResponse,
            timestamp: Date.now(),
            isProcessed: true
          }).then(() => {
            console.log("âœ… Steve AI responded");
          }).catch(error => {
            console.error("âŒ Error sending Steve's response to database:", error);
          });
        }).catch(error => {
          console.error("âŒ Error removing typing indicator:", error);
        });
      }, Math.random() * 1000 + 500); // Random delay between 500-1500ms for more natural feeling
    }).catch(error => {
      console.error("âŒ Error setting typing indicator:", error);
    });
  }).catch(error => {
    console.error("âŒ Error sending message to Steve AI:", error);
  });
}, 500); // 500ms debounce to prevent rapid multiple message sends

// Function to check if a chat is with Steve
function isSteveChat(selectedUserID) {
  return selectedUserID === STEVE.uid;
}
// ===== END OF IMPROVED STEVE AI CONFIGURATION =====

 const firebaseConfig = {
   apiKey: "AIzaSyDFhghmxUfCJbnnOFsleHoatF7D-ubnLpU",
   authDomain: "project-8042491080443698183.firebaseapp.com",
   databaseURL: "https://project-8042491080443698183-default-rtdb.firebaseio.com",
   projectId: "project-8042491080443698183",
   storageBucket: "project-8042491080443698183.firebasestorage.app",
   messagingSenderId: "583304911847",
   appId: "1:583304911847:web:8dfe3e5c016062dd457b42",
   measurementId: "G-KQMXKEVNQ7"
 };
 
 const app = initializeApp(firebaseConfig);
 const db = getDatabase(app);
 const auth = getAuth(app);
 
 let currentUser = null;
 let currentUsername = null;
 let selectedUser = null;
 let selectedUsername = null;
 let chatID = null;
 let chatUsers = [];
 let currentAction = null;
 let actionUser = null;
 let userCache = {}; // Cache user data to avoid repeated lookups
 let usernameResolvers = {}; // Map of email addresses to usernames
 
 // Emoji picker functionality
 const emojiButton = document.getElementById("emojiButton");
 const emojiPicker = document.getElementById("emojiPicker");
 const emojiTabs = document.querySelectorAll(".emoji-tab");
 const emojis = document.querySelectorAll(".emoji");
 const messageInput = document.getElementById("messageInput");
 
 // Toggle emoji picker
 emojiButton.addEventListener("click", function() {
   emojiPicker.style.display = emojiPicker.style.display === "none" ? "block" : "none";
 });
 
 // Tab switching
 emojiTabs.forEach(tab => {
   tab.addEventListener("click", function() {
     // Remove active class from all tabs
     emojiTabs.forEach(t => t.classList.remove("active"));
     
     // Add active class to clicked tab
     this.classList.add("active");
     
     // Hide all categories
     document.querySelectorAll(".emoji-category").forEach(category => {
       category.classList.remove("active");
     });
     
     // Show selected category
     const categoryId = this.getAttribute("data-category");
     document.getElementById(categoryId).classList.add("active");
     
     // Log for debugging
     console.log(`Showing emoji category: ${categoryId}`);
   });
 });
 
 // Initialize emoji tabs - ensure first tab is active by default
 document.querySelector(".emoji-tab[data-category='smileys']").click();
 
 // Emoji selection
 emojis.forEach(emoji => {
   emoji.addEventListener("click", function() {
     const emojiChar = this.getAttribute("data-emoji");
     
     // Insert emoji at cursor position
     const cursorPosition = messageInput.selectionStart;
     const textBefore = messageInput.value.substring(0, cursorPosition);
     const textAfter = messageInput.value.substring(cursorPosition);
     
     messageInput.value = textBefore + emojiChar + textAfter;
     
     // Set cursor position after inserted emoji
     messageInput.focus();
     messageInput.selectionStart = cursorPosition + emojiChar.length;
     messageInput.selectionEnd = cursorPosition + emojiChar.length;
     
     // Hide emoji picker after selection
     emojiPicker.style.display = "none";
   });
 });
 
 // Close emoji picker if clicked outside
 document.addEventListener("click", function(event) {
   if (!emojiPicker.contains(event.target) && event.target !== emojiButton) {
     emojiPicker.style.display = "none";
   }
 });
 let inactivityTimer; // add a timer to check away status
 let userStatusRef;
 onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    console.log("âœ… Logged in as:", currentUser.email);
   
    const usersRef = ref(db, `users/${currentUser.uid}`);
    get(usersRef).then((snapshot) => {
      if (snapshot.exists()) {
        currentUsername = snapshot.val().username;
        // Cache current user data
        userCache[currentUser.uid] = snapshot.val();
        // Cache email to username mapping
        usernameResolvers[currentUser.email] = currentUsername;
       
        const userStatusRef = ref(db, `users/${currentUser.uid}/status`);
        set(userStatusRef, "online");
        onDisconnect(userStatusRef).set("offline");

        // Start loading data
        preloadAllUserData().then(() => {
          loadUsers();
          setupSearch();
          setupSteve(); // Add this line to initialize Steve
        });
        startInactivityTimer();
      } else {
        console.error("âŒ Current user data not found.");
      }
    });
  } else {
    window.location.href = "../LoginPage/user_login.html";
  }
});

function startInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    set(userStatusRef, "away");
  }, 60000);
}
["mousemove", "keydown", "click", "scroll"].forEach(event => {
  window.addEventListener(event, () => {
    set(userStatusRef, "online");
    startInactivityTimer();
  });
});
startInactivityTimer();
// Function to set up Steve AI in the user list
function setupSteve() {
  console.log("Setting up Steve...");
 
  // Refresh current user data first
  refreshCurrentUserData().then(() => {
    // Then initialize Steve
    initializeSteve(db);
   
    // Add Steve to user list
    setTimeout(() => {
      const userList = document.getElementById("userList");
      if (!userList) {
        console.error("userList element not found!");
        return;
      }
     
      console.log("Adding Steve to user list");
     
      // Check if Steve is already in the list
      if (!document.getElementById(`user-${STEVE.uid}`)) {
        const steveDiv = document.createElement("div");
        steveDiv.classList.add("user");
        steveDiv.id = `user-${STEVE.uid}`;
       
        const nameSpan = document.createElement("span");
        nameSpan.textContent = STEVE.username;
        steveDiv.appendChild(nameSpan);
       
        const statusSpan = document.createElement("span");
        statusSpan.classList.add("status-indicator");
        statusSpan.textContent = "ğŸŸ¢ Online";  // Steve is always online
        steveDiv.appendChild(statusSpan);
       
        // Add Steve at the beginning of the user list
        if (userList.firstChild) {
          userList.insertBefore(steveDiv, userList.firstChild);
        } else {
          userList.appendChild(steveDiv);
        }
       
        // Add click event listener to start chat with Steve
        steveDiv.addEventListener("click", function() {
          console.log("Steve clicked! Starting chat...");
          startChat(STEVE);
        });
       
        console.log("Steve added to user list");
      } else {
        console.log("Steve already exists in user list");
      }
    }, 2000); // Increased delay to ensure the user list is loaded
  }).catch(error => {
    console.error("Error setting up Steve:", error);
  });
}

 // Preload ALL user data to fix the "Unknown User" issues
 async function preloadAllUserData() {
   console.log("ğŸ”„ Loading all user data...");
   const usersRef = ref(db, "users");
   
   try {
     const snapshot = await get(usersRef);
     if (snapshot.exists()) {
       // First build the UID to user data cache
       snapshot.forEach((childSnapshot) => {
         const userData = childSnapshot.val();
         if (userData.uid) {
           userCache[userData.uid] = userData;
           
           // Also map email to username and UID for quicker lookups
           if (userData.email && userData.username) {
             usernameResolvers[userData.email] = userData.username;
           }
         }
       });
       
       console.log(`âœ… Preloaded data for ${Object.keys(userCache).length} users`);
     }
   } catch (error) {
     console.error("âŒ Error preloading user data:", error);
   }
 }
 
 // Function to find username by email
 function getUsernameByEmail(email) {
   // First check our resolver cache
   if (usernameResolvers[email]) {
     return usernameResolvers[email];
   }
   
   // If not found, check all users in userCache
   for (const uid in userCache) {
     const user = userCache[uid];
     if (user.email === email) {
       // Cache this for future lookups
       usernameResolvers[email] = user.username;
       return user.username;
     }
   }
   
   return null;
 }
 
 // Function to find user by email
 function getUserByEmail(email) {
   for (const uid in userCache) {
     const user = userCache[uid];
     if (user.email === email) {
       return user;
     }
   }
   return null;
 }
 
 function loadUsers() {
  const userList = document.getElementById("userList");
  userList.innerHTML = "";

  const chatsRef = ref(db, "chats");
  const blockedRef = ref(db, `blocked/${currentUser.uid}`);

  // First get the blocked users
  get(blockedRef).then((blockedSnapshot) => {
    let blockedUsers = {};
    if (blockedSnapshot.exists()) {
      blockedSnapshot.forEach(childSnapshot => {
        blockedUsers[childSnapshot.key] = childSnapshot.val();
      });
    }

    // Then get all chats
    get(chatsRef).then((snapshot) => {
      if (snapshot.exists()) {
        let chatUserIDs = new Set();
        let blockedUserIDs = new Set();

        // Identify users from chats
        snapshot.forEach((chatSnapshot) => {
          const [userA, userB] = chatSnapshot.key.split("_");
          if (userA === currentUser.uid) {
            chatUserIDs.add(userB);
            if (blockedUsers[userB]) {
              blockedUserIDs.add(userB);
            }
          } else if (userB === currentUser.uid) {
            chatUserIDs.add(userA);
            if (blockedUsers[userA]) {
              blockedUserIDs.add(userA);
            }
          }
        });

        if (chatUserIDs.size === 0) {
          userList.innerHTML = "<p>No conversations yet.</p>";
          return;
        }

        chatUsers = [];
       
        // Add active users
        chatUserIDs.forEach(uid => {
          if (userCache[uid]) {
            // Check if user is blocked
            if (blockedUsers[uid]) {
              userCache[uid].isBlocked = true;
            } else {
              userCache[uid].isBlocked = false;
            }
            chatUsers.push(userCache[uid]);
          }
        });

        displayUsers(chatUsers);
      } else {
        userList.innerHTML = "<p>No conversations found.</p>";
      }
    }).catch(error => {
      console.error("âŒ Error loading conversations:", error);
      userList.innerHTML = "<p>Error loading conversations.</p>";
    });
  });
}
 
 function setupSearch() {
   const searchInput = document.getElementById("searchUser");
   
   // Add a debounce function to avoid too many searches
   let searchTimeout;
   
   searchInput.addEventListener("input", () => {
     clearTimeout(searchTimeout);
     searchTimeout = setTimeout(() => {
       const searchValue = searchInput.value.trim().toLowerCase();
       
       if (searchValue === "") {
         displayUsers(chatUsers); // Show previous chats again
       } else {
         searchAllUsers(searchValue); // Search all users
       }
     }, 300); // 300ms debounce
   });
 }
 
 function searchAllUsers(searchValue) {
   const userList = document.getElementById("userList");
   
   // Search in userCache
   let filteredUsers = Object.values(userCache).filter(user =>
     user.uid !== currentUser.uid &&
     user.username &&
     user.username.toLowerCase().includes(searchValue)
   );
   
   displayUsers(filteredUsers);
 }
 
 function displayUsers(users) {
  const userList = document.getElementById("userList");
  userList.innerHTML = "";
 
  if (users.length === 0) {
    userList.innerHTML = "<p>No users found.</p>";
  } else {
    users.forEach(user => {
      let userDiv = document.createElement("div");
      userDiv.classList.add("user");
      userDiv.id = `user-${user.uid}`;
     
      // Create a wrapper for username and buttons
      const contentWrapper = document.createElement("div");
      contentWrapper.className = "user-content-wrapper";
     
      const nameSpan = document.createElement("span");
      nameSpan.textContent = user.username;
      contentWrapper.appendChild(nameSpan);
     
      // Apply blocked styling if the user is blocked
      if (user.isBlocked) {
        userDiv.classList.add("blocked-user");
       
        // Add unblock button
        const unblockButton = document.createElement("button");
        unblockButton.className = "unblock-button";
        unblockButton.textContent = "Unblock";
        unblockButton.addEventListener("click", (event) => {
          event.stopPropagation(); // Prevent triggering the chat
          unblockUser(user);
        });
        contentWrapper.appendChild(unblockButton);
      }
     
      userDiv.appendChild(contentWrapper);
     
      const statusSpan = document.createElement("span");
      statusSpan.classList.add("status-indicator");
      statusSpan.textContent = "âšªï¸ Offline";  // initial as offline
      userDiv.appendChild(statusSpan);

      userList.appendChild(userDiv);
      listenUserStatus(user.uid);

      // Only add chat functionality if user isn't blocked
      if (!user.isBlocked) {
        userDiv.addEventListener("click", () => startChat(user));
      }
     
      userDiv.addEventListener("contextmenu", (event) => {
        event.preventDefault();
        showContextMenu(event, user);
      });
    });
  }
}

function unblockUser(user) {
  if (!user || !user.uid) {
    console.error("Invalid user for unblocking");
    return;
  }

  // Reference to the blocked user entry
  const blockedRef = ref(db, `blocked/${currentUser.uid}/${user.uid}`);
 
  // Remove the blocked entry
  set(blockedRef, null)
    .then(() => {
      console.log(`âœ… User ${user.username} has been unblocked`);
     
      // Update UI - remove blocked class and add click event
      const userDiv = document.getElementById(`user-${user.uid}`);
      if (userDiv) {
        userDiv.classList.remove("blocked-user");
       
        // Remove the unblock button
        const unblockButton = userDiv.querySelector(".unblock-button");
        if (unblockButton) {
          unblockButton.remove();
        }
       
        // Re-add the click event to start chat
        userDiv.addEventListener("click", () => startChat(user));
      }
     
      // Update the user in cache
      if (userCache[user.uid]) {
        userCache[user.uid].isBlocked = false;
      }
     
      // Show confirmation message
      alert(`You have unblocked ${user.username}`);
    })
    .catch(error => {
      console.error("âŒ Error unblocking user:", error);
      alert("Failed to unblock user. Please try again.");
    });
}
 
 function startChat(user) {
  selectedUser = user;
  selectedUsername = user.username;
 
  // Debug information
  console.log("Starting chat with:", user);
  console.log("Username:", selectedUsername);
  console.log("UID:", user.uid);
 
  document.getElementById("chatUserName").innerText = `Chat with ${selectedUsername}`;
 
  // Generate proper chat ID
  chatID = user.uid === STEVE.uid
    ? (currentUser.uid < STEVE.uid ? `${currentUser.uid}_${STEVE.uid}` : `${STEVE.uid}_${currentUser.uid}`)
    : generateChatID(currentUser.uid, user.uid);
   
  console.log(`ğŸ“© Chat started with ${selectedUsername} (Chat ID: ${chatID})`);
 
  // Clear messages div
  document.getElementById("messages").innerHTML = "";
 
  // If it's Steve, we need to ensure the current user data is fully loaded
  if (user.uid === STEVE.uid) {
    console.log("Starting chat with Steve AI");
   
    // Make sure we have current user data
    const usersRef = ref(db, `users/${currentUser.uid}`);
    get(usersRef).then((snapshot) => {
      if (snapshot.exists()) {
        // Update current user data
        currentUsername = snapshot.val().username;
        userCache[currentUser.uid] = snapshot.val();
        console.log("Current user data refreshed:", currentUsername);
      }
      // Load messages anyway
      loadMessages();
    }).catch(error => {
      console.error("Error refreshing user data:", error);
      // Load messages anyway
      loadMessages();
    });
  } else {
    // Normal user chat
    loadMessages();
  }
}

function refreshCurrentUserData() {
  if (!currentUser || !currentUser.uid) {
    console.error("Cannot refresh user data: currentUser is not defined");
    return Promise.reject("No current user");
  }
 
  return new Promise((resolve, reject) => {
    const userRef = ref(db, `users/${currentUser.uid}`);
    get(userRef).then((snapshot) => {
      if (snapshot.exists()) {
        const userData = snapshot.val();
       
        // Update global variables with user data
        currentUsername = userData.username;
        currentUser.username = userData.username;
        currentUser.profilePicture = userData.profilePicture;
       
        // Update cache
        userCache[currentUser.uid] = userData;
       
        console.log("âœ… Current user data refreshed:", currentUsername);
        resolve(userData);
      } else {
        console.error("âŒ User data not found");
        reject("User data not found");
      }
    }).catch(error => {
      console.error("âŒ Error fetching user data:", error);
      reject(error);
    });
  });
}
 
 function generateChatID(userA, userB) {
   return userA < userB ? `${userA}_${userB}` : `${userB}_${userA}`;
 }
 
 function loadMessages() {
   const messagesDiv = document.getElementById("messages");
   messagesDiv.innerHTML = "";
   const chatRef = ref(db, `chats/${chatID}/messages`);
   
   // Keep track of messages we've already rendered
   const renderedMessageIds = new Set();
   
   // First, get all messages at once and sort them
   get(chatRef).then((snapshot) => {
     if (snapshot.exists()) {
       let messages = [];
       
       snapshot.forEach(childSnapshot => {
         const message = childSnapshot.val();
         if (!message.deleted) {
           messages.push({
             id: childSnapshot.key,
             ...message
           });
         }
         // Add to our tracking set
         renderedMessageIds.add(childSnapshot.key);
       });
       
       // Sort messages by timestamp (oldest first)
       messages.sort((a, b) => a.timestamp - b.timestamp);
       
       // Process each message in order
       const processMessages = async () => {
         for (const message of messages) {
           await renderMessage(message, message.id);
         }
         // Scroll to the bottom after all messages are rendered
         messagesDiv.scrollTop = messagesDiv.scrollHeight;
       };
       
       processMessages();
     }
   }).then(() => {
     // Only after initial load is complete, listen for new messages
     onChildAdded(chatRef, async (snapshot) => {
       const messageData = snapshot.val();
       const messageId = snapshot.key;
       
       // Skip deleted messages and messages we've already rendered
       if (messageData.deleted || renderedMessageIds.has(messageId)) {
         return;
       }
       
       // Add to our tracking set
       renderedMessageIds.add(messageId);
       
       await renderMessage(messageData, messageId);
       messagesDiv.scrollTop = messagesDiv.scrollHeight;
     });
     
     // Listen for changes to existing messages (for real-time deletion)
     onChildChanged(chatRef, (snapshot) => {
       const messageData = snapshot.val();
       const messageId = snapshot.key;
       
       // If the message is marked as deleted, hide it
       if (messageData.deleted) {
         const messageElement = document.getElementById(messageId);
         if (messageElement) {
           messageElement.style.transition = "opacity 0.5s, height 0.5s, margin 0.5s";
           messageElement.style.opacity = "0";
           messageElement.style.height = "0";
           messageElement.style.margin = "0";
           messageElement.style.overflow = "hidden";
           
           setTimeout(() => {
             messageElement.style.display = "none";
           }, 500);
           
           console.log(`ğŸ—‘ï¸ Message ${messageId} was deleted by another user.`);
         }
       }
     });
   });
 }
 
 async function resolveUsername(uid) {
   // First check cache
   if (userCache[uid] && userCache[uid].username) {
     return userCache[uid].username;
   }
   
   // If not in cache, fetch from database
   try {
     const userRef = ref(db, `users/${uid}`);
     const snapshot = await get(userRef);
     if (snapshot.exists()) {
       const userData = snapshot.val();
       // Update cache
       userCache[uid] = userData;
       listenUserStatus(uid);
       return userData.username;
     }
   } catch (error) {
     console.error("Error fetching username:", error);
   }
   
   return "Unknown User";
 }

 function listenUserStatus(userId) {
   const userDiv = document.getElementById(`user-${userId}`);
   
   if (!userDiv) return; // Skip if user element doesn't exist
   
   if (!userDiv.querySelector('.status-indicator')) {
     const indicator = document.createElement('span');
     indicator.className = 'status-indicator';
     indicator.textContent = 'âšªï¸ Offline';
     userDiv.appendChild(indicator);
   }

   const statusRef = ref(db, `users/${userId}/status`);

   onValue(statusRef, (snapshot) => {
     const status = snapshot.val();
     const indicator = userDiv.querySelector('.status-indicator');

     if (indicator) {
      if (status === "online") {
      indicator.textContent = "ğŸŸ¢ Online";
      indicator.style.color = "white";
    } else if (status === "away") {
      indicator.textContent = "ğŸŸ¡ Away";
      indicator.style.color = "white";
    } else {
      indicator.textContent = "âšªï¸ Offline";
      indicator.style.color = "white";
    }
       // Add animation for status change
       indicator.style.transition = "opacity 0.3s";
       indicator.style.opacity = 0.5;
       setTimeout(() => { indicator.style.opacity = 1; }, 50);
     }
   });
 }

 async function resolveProfilePic(uid, defaultPic = "data:image/jpeg;base64,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") {
    // First check cache
    if (userCache[uid] && userCache[uid].profilePicture) {
     return userCache[uid].profilePicture;
   }
   
   // If not in cache, fetch from database
   try {
     const userRef = ref(db, `users/${uid}`);
     const snapshot = await get(userRef);
     if (snapshot.exists()) {
       const userData = snapshot.val();
       // Update cache
       userCache[uid] = userData;
       return userData.profilePicture || defaultPic;
     }
   } catch (error) {
     console.error("Error fetching profile picture:", error);
   }
   
   return defaultPic;
 }

 async function renderMessage(messageData, messageId) {
  const messagesDiv = document.getElementById("messages");

  // Create message element
  const messageElement = document.createElement("div");
  messageElement.classList.add("message");
  messageElement.id = messageId;
 
  // Determine message type (sent or received)
  const isSentByCurrentUser = messageData.sender === currentUser.email;
  messageElement.classList.add(isSentByCurrentUser ? "sent" : "received");

  // Create message wrapper - this will hold profile pic + content
  const messageWrapper = document.createElement("div");
  messageWrapper.className = "messageWrapper";

  // Resolve profile picture URL
  let profilePicURL = messageData.profilePicture;
  let senderUID = messageData.senderUID;
  if (!profilePicURL && senderUID) {
    profilePicURL = await resolveProfilePic(senderUID);
  } else if (!profilePicURL) {
    profilePicURL = "data:image/jpeg;base64,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";
    }

    // Create profile picture element
  const profilePic = document.createElement("img");
  profilePic.src = profilePicURL;
  profilePic.className = "profile-pic";
  profilePic.alt = `${messageData.senderUsername}'s profile picture`;

  // Create message content container
  const contentDiv = document.createElement("div");
  contentDiv.className = "message-content";
 
  // Create username header
  const headerDiv = document.createElement("div");
  headerDiv.className = "message-header";
  headerDiv.textContent = messageData.senderUsername || "Unknown User";
 
  // Create message text
  const textDiv = document.createElement("div");
  textDiv.className = "message-text";
  textDiv.textContent = messageData.text;
 
  // Create timestamp
  const timeDiv = document.createElement("div");
  timeDiv.className = "message-time";
  timeDiv.textContent = messageData.timestamp ? new Date(messageData.timestamp).toLocaleTimeString() : "";
 
  // Assemble message content
  contentDiv.appendChild(headerDiv);
  contentDiv.appendChild(textDiv);
  contentDiv.appendChild(timeDiv);
 
  // Add reply button
  const replyButton = document.createElement("button");
  replyButton.className = "reply-button";
  replyButton.textContent = "Reply";
  replyButton.addEventListener("click", () => replyToMessage(messageData));
 
  // Add delete button for sender's messages
  if (messageData.sender === currentUser.email) {
    const deleteButton = document.createElement("button");
    deleteButton.className = "delete-btn";
    deleteButton.innerHTML = "&times;";
    deleteButton.setAttribute("data-message-id", messageId);
   
    // Add click event to delete message
    deleteButton.addEventListener("click", (event) => {
      event.stopPropagation();
      deleteMessage(messageId);
    });
   
    messageElement.appendChild(deleteButton);
  }

  // Append profile pic and content to wrapper based on message type
  if (isSentByCurrentUser) {
    // For sent messages: content first, then profile pic (right side)
    messageWrapper.appendChild(contentDiv);
    messageWrapper.appendChild(profilePic);
  } else {
    // For received messages: profile pic first, then content (left side)
    messageWrapper.appendChild(profilePic);
    messageWrapper.appendChild(contentDiv);
  }

  // Append the wrapper to the message element
  messageElement.appendChild(messageWrapper);
  messageElement.appendChild(replyButton);

  // Add message to DOM
  messagesDiv.appendChild(messageElement);
}

 function deleteMessage(messageId) {
   if (!messageId || !chatID) {
     console.error("âŒ Missing messageId or chatID for deletion");
     return;
   }

   // Reference to the specific message
   const messageRef = ref(db, `chats/${chatID}/messages/${messageId}`);
   
   // Mark the message as deleted instead of removing it completely
   // This maintains conversation context while hiding the message
   update(messageRef, {
     deleted: true
   }).then(() => {
     // Hide the message element in the UI with animation
     const messageElement = document.getElementById(messageId);
     if (messageElement) {
       messageElement.style.transition = "opacity 0.5s, height 0.5s, margin 0.5s";
       messageElement.style.opacity = "0";
       messageElement.style.height = "0";
       messageElement.style.margin = "0";
       messageElement.style.overflow = "hidden";
       
       setTimeout(() => {
         messageElement.style.display = "none";
       }, 500);
       
       console.log(`ğŸ—‘ï¸ Message ${messageId} deleted successfully.`);
     }
   }).catch(error => {
     console.error("âŒ Error deleting message:", error);
     alert("Failed to delete message. Please try again.");
   });
 }

 function replyToMessage(messageData) {
   // Make sure we have the message data
   if (!messageData || !messageData.text || !messageData.senderUsername) {
     console.error("Invalid message data for reply");
     return;
   }

   const chatInput = document.getElementById("messageInput");
   if (!chatInput) {
     console.error("messageInput element not found");
     return;
   }

   // Create the quoted text with sender's name
   const replyText = `${messageData.senderUsername}: "${messageData.text}"`;
   
   // Format as quote
   const quoteText = `> ${replyText}\n\n`;
   
   // Add to beginning of input
   chatInput.value = `${quoteText}${chatInput.value}`;
   
   // Focus and place cursor at end
   chatInput.focus();
   chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length);
 }

 // Context menu functions
 function showContextMenu(event, user) {
   const contextMenu = document.getElementById("contextMenu");
   contextMenu.style.display = "block";
   contextMenu.style.left = `${event.pageX}px`;
   contextMenu.style.top = `${event.pageY}px`;

   document.getElementById("reportOption").onclick = () => reportUser(user);
   document.getElementById("blockOption").onclick = () => blockUser(user);
 }

 function reportUser(user) {
   currentAction = "report";
   actionUser = user;
   showReasonModal();
 }

 function blockUser(user) {
   currentAction = "block";
   actionUser = user;
   showReasonModal();
 }

 function showReasonModal() {
   const reasonModal = document.getElementById("reasonModal");
   const reasonText = document.getElementById("reasonText");
   reasonText.value = "";
   reasonModal.style.display = "flex";
 }

 document.getElementById("submitReason").addEventListener("click", function() {
   const reason = document.getElementById("reasonText").value.trim();
   if (!reason) {
     alert("Please provide a reason.");
     return;
   }

   if (currentAction === "block" && actionUser) {
     const blockedRef = ref(db, `blocked/${currentUser.uid}/${actionUser.uid}`);
     update(blockedRef, { blocked: true, reason: reason }).then(() => {
       alert(`ğŸš« You have blocked ${actionUser.username}.`);
       document.getElementById("reasonModal").style.display = "none";
       loadUsers(); // Refresh the user list
     }).catch(error => {
       console.error("âŒ Error blocking user:", error);
     });
   } else if (currentAction === "report" && actionUser) {
     const reportsRef = ref(db, `reports/${actionUser.uid}`);
     push(reportsRef, {
       reportedBy: currentUser.uid,
       reason: reason,
       timestamp: Date.now()
     }).then(() => {
       alert(`ğŸš© You have reported ${actionUser.username}.`);
       document.getElementById("reasonModal").style.display = "none";
     }).catch(error => {
       console.error("âŒ Error reporting user:", error);
     });
   }
 });

 document.getElementById("cancelReason").addEventListener("click", function() {
   document.getElementById("reasonModal").style.display = "none";
 });

 // Close context menu if clicked outside
 document.addEventListener("click", (event) => {
   const contextMenu = document.getElementById("contextMenu");
   if (contextMenu.style.display === "block" && !contextMenu.contains(event.target)) {
     contextMenu.style.display = "none";
   }
 });
 
 document.getElementById("messageInput").addEventListener("keypress", function (event) {
   if (event.key === "Enter") {
     event.preventDefault();
     document.getElementById("sendMessage").click();
   }
 });
 
 document.getElementById("sendMessage").addEventListener("click", async function() {
   if (!selectedUser) {
     alert("Select a user first!");
     return;
   }

   // Check if the selected user has blocked the current user
   const blockedBySelectedUserRef = ref(db, `blocked/${selectedUser.uid}/${currentUser.uid}`);
   const blockedSnapshot = await get(blockedBySelectedUserRef);

   if (blockedSnapshot.exists()) {
     alert(`ğŸš« You have been blocked by ${selectedUser.username}.`);
     return;
   }

   const blockedByCurrentUserRef = ref(db, `blocked/${currentUser.uid}/${selectedUser.uid}`);
   const blockedByCurrentSnapshot = await get(blockedByCurrentUserRef);

   if (blockedByCurrentSnapshot.exists()) {
     alert("ğŸš« You have blocked this user. Unblock them to send messages.");
     return;
   }

   // Get message text
     // Get message text
  const messageInput = document.getElementById("messageInput");
  const messageText = messageInput.value.trim();
  if (messageText === "") return;
 
  console.log("Sending message to:", selectedUser.username);
  console.log("Selected user ID:", selectedUser.uid);
  console.log("Is Steve?", isSteveChat(selectedUser.uid));
 
  // Check if this is a chat with Steve
  if (selectedUser.uid === STEVE.uid) {
    console.log("This is a chat with Steve!");
    sendMessageToSteve(db, currentUser, messageText);
    messageInput.value = "";
    return;
  }

   // Show sending indicator
   const tempId = "temp-" + Date.now();
   const messagesDiv = document.getElementById("messages");
   const tempMessage = document.createElement("div");
   tempMessage.id = tempId;
   tempMessage.className = "message sent";
   tempMessage.innerHTML = `
     <div class="message-container">
       <div class="user-wrapper">
         <img src="data:image/jpeg;base64,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" class="message-profile">
         <span class="message-username">${currentUser.username}</span>
       </div>
       <div class="message-content">
         <p class="message-text">${messageText}</p>
         <div class="message-timestamp">Sending...</div>
       </div>
     </div>
   `;
   messagesDiv.appendChild(tempMessage);
   messagesDiv.scrollTop = messagesDiv.scrollHeight;

   // Clear input immediately for better UX
   messageInput.value = "";

   try {
     // Retrieve the current user's profile picture
     let profilePicURL = "data:image/jpeg;base64,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";

 if (userCache[currentUser.uid] && userCache[currentUser.uid].profilePicture) {
       profilePicURL = userCache[currentUser.uid].profilePicture;
     } else {
       profilePicURL = await resolveProfilePic(currentUser.uid);
     }

     // Send message to database
     const chatRef = ref(db, `chats/${chatID}/messages`);
     const newMessage = {
       sender: currentUser.email,
       senderUID: currentUser.uid,
       senderUsername: currentUsername,
       profilePicture: profilePicURL,
       text: messageText,
       timestamp: Date.now()
     };

     const newMessageRef = push(chatRef, newMessage);

     // Remove temp message (will be replaced by real-time listener)
     document.getElementById(tempId).remove();
   } catch (error) {
     console.error("Error sending message:", error);
     
     // Remove temp message and show error
     document.getElementById(tempId).remove();
     alert("Failed to send message. Please try again.");
   }
 });

 document.getElementById("logoutButton").addEventListener("click", function () {
   console.log("ğŸš€ Logout button clicked!");
   
   signOut(auth).then(() => {
     console.log("âœ… User logged out. Redirecting...");
     
     // Try the approach that works for the server interface
     window.location.replace("../../Sprint1/LoginPage/user_login.html");
     
     // Fallback options if the above doesn't work
     setTimeout(() => {
       if (window.location.href.includes("DirectMessaging")) {
         // If we're still here after a short delay, try another approach
         window.top.location.href = "../../Sprint1/LoginPage/user_login.html";
       }
     }, 200);
   }).catch(error => {
     console.error("âŒ Logout failed:", error);
   });
 });
 </script>
</body>
</html>
