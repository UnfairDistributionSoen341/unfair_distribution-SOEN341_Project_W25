<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatHaven - Direct Messages</title>
    <link rel="stylesheet" href="./dm.css">
    <style>
        .message .delete-button {
            cursor: pointer;
            color: red;
            font-size: 12px;
            margin-left: 10px;
        }
        #contextMenu {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        #contextMenu ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        #contextMenu li {
            padding: 8px 12px;
            cursor: pointer;
        }
        #contextMenu li:hover {
            background-color: #f1f1f1;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 300px;
        }
        .modal-content textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }
        #logoutButton {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: red;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
        }
        #logoutButton:hover {
            background-color: darkred;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="sidebar">
            <h2>Direct Messages</h2>
            <input type="text" id="searchUser" placeholder="Search for a user...">
            <div id="userList"></div>
        </div>

        <div class="chat-box">
            <h2 id="chatUserName">Select a user to chat</h2>
            <div id="messages"></div>
            <div class="message-input">
                <input type="text" id="messageInput" placeholder="Type a message...">
                <button id="sendMessage">Send</button>
            </div>
        </div>
    </div>
    <button id="logoutButton">Logout</button>

    <div id="contextMenu">
        <ul>
            <li id="reportOption">Report</li>
            <li id="blockOption">Block</li>
        </ul>
    </div>
    <div id="reasonModal" class="modal">
        <div class="modal-content">
            <h3>Provide a reason</h3>
            <textarea id="reasonText" placeholder="Enter your reason here..."></textarea>
            <button id="submitReason">Submit</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, get, update } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFhghmxUfCJbnnOFsleHoatF7D-ubnLpU",
            authDomain: "project-8042491080443698183.firebaseapp.com",
            databaseURL: "https://project-8042491080443698183-default-rtdb.firebaseio.com",
            projectId: "project-8042491080443698183",
            storageBucket: "project-8042491080443698183.firebasestorage.app",
            messagingSenderId: "583304911847",
            appId: "1:583304911847:web:8dfe3e5c016062dd457b42",
            measurementId: "G-KQMXKEVNQ7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentUsername = null;
        let selectedUser = null;
        let selectedUsername = null;
        let chatID = null;
        let chatUsers = [];

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("✅ Logged in as:", currentUser.email);

                const usersRef = ref(db, `users/${currentUser.uid}`);
                get(usersRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        currentUsername = snapshot.val().username;
                        loadUsers();
                        setupSearch();
                    } else {
                        console.error("❌ Current user data not found.");
                    }
                });

            } else {
                window.location.href = "../LoginPage/user_login.html";
            }
        });

        function loadUsers() {
            const userList = document.getElementById("userList");
            userList.innerHTML = "";

            const chatsRef = ref(db, "chats");

            get(chatsRef).then((snapshot) => {
                if (snapshot.exists()) {
                    let chatUserIDs = new Set();

                    snapshot.forEach((chatSnapshot) => {
                        const chatKey = chatSnapshot.key;
                        const [userA, userB] = chatKey.split("_");

                        if (userA === currentUser.uid) {
                            chatUserIDs.add(userB);
                        } else if (userB === currentUser.uid) {
                            chatUserIDs.add(userA);
                        }
                    });

                    if (chatUserIDs.size === 0) {
                        userList.innerHTML = "<p>No conversations yet.</p>";
                        return;
                    }

                    const usersRef = ref(db, "users");

                    get(usersRef).then((userSnapshot) => {
                        if (userSnapshot.exists()) {
                            chatUsers = [];

                            userSnapshot.forEach((childSnapshot) => {
                                let user = childSnapshot.val();
                                if (chatUserIDs.has(user.uid)) {
                                    chatUsers.push(user);
                                }
                            });

                            displayUsers(chatUsers);

                        } else {
                            userList.innerHTML = "<p>No users found.</p>";
                        }
                    });

                } else {
                    userList.innerHTML = "<p>No conversations found.</p>";
                }
            }).catch(error => {
                console.error("❌ Error loading conversations:", error);
                userList.innerHTML = "<p>Error loading conversations.</p>";
            });
        }

        function setupSearch() {
            const searchInput = document.getElementById("searchUser");
            searchInput.addEventListener("input", () => {
                const searchValue = searchInput.value.trim().toLowerCase();

                if (searchValue === "") {
                    displayUsers(chatUsers); // Show previous chats again
                } else {
                    searchAllUsers(searchValue); // Search all users
                }
            });
        }

        function searchAllUsers(searchValue) {
            const userList = document.getElementById("userList");
            const usersRef = ref(db, "users");

            get(usersRef).then((snapshot) => {
                if (snapshot.exists()) {
                    let filteredUsers = [];

                    snapshot.forEach((childSnapshot) => {
                        let user = childSnapshot.val();
                        if (
                            user.uid !== currentUser.uid &&
                            user.username.toLowerCase().includes(searchValue)
                        ) {
                            filteredUsers.push(user);
                        }
                    });

                    displayUsers(filteredUsers);

                } else {
                    userList.innerHTML = "<p>No users found.</p>";
                }
            }).catch(error => {
                console.error("❌ Error searching users:", error);
                userList.innerHTML = "<p>Error searching users.</p>";
            });
        }

        function displayUsers(users) {
            const userList = document.getElementById("userList");
            userList.innerHTML = "";

            if (users.length === 0) {
                user